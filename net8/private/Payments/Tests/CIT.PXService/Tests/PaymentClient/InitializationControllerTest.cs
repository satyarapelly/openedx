// <copyright company="Microsoft Corporation">Copyright (c) Microsoft 2022. All rights reserved.</copyright>

namespace CIT.PXService.Tests
{
    using global::Tests.Common.Model.Pidl;
    using Microsoft.Commerce.Payments.Common;
    using Microsoft.Commerce.Payments.PXCommon;
    using Microsoft.VisualStudio.TestTools.UnitTesting;
    using Newtonsoft.Json;
    using Newtonsoft.Json.Linq;
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Net;
    using System.Net.Http;
    using System.Text;
    using System.Threading.Tasks;

    [TestClass]
    public class InitializationControllerTest : TestBase
    {
        [TestInitialize]
        public void Startup()
        {
            PXSettings.AddressEnrichmentService.Responses.Clear();
            PXSettings.AccountsService.Responses.Clear();
            PXSettings.PimsService.Responses.Clear();
            PXSettings.TokenPolicyService.Responses.Clear();
            PXSettings.PurchaseService.Responses.Clear();
            PXSettings.PartnerSettingsService.Responses.Clear();
            PXSettings.OrchestrationService.Responses.Clear();
            PXSettings.IssuerService.Responses.Clear();
            PXSettings.CatalogService.Responses.Clear();

            PXSettings.AddressEnrichmentService.ResetToDefaults();
            PXSettings.AccountsService.ResetToDefaults();
            PXSettings.PimsService.ResetToDefaults();
            PXSettings.TokenPolicyService.ResetToDefaults();
            PXSettings.PurchaseService.ResetToDefaults();
            PXSettings.PartnerSettingsService.ResetToDefaults();
            PXSettings.OrchestrationService.ResetToDefaults();
            PXSettings.IssuerService.ResetToDefaults();
            PXSettings.CatalogService.ResetToDefaults();
            PXSettings.PaymentOrchestratorService.ResetToDefaults();
        }

        [DataRow(true, false)]
        [DataRow(false, false)]
        [DataRow(true, true)]
        [DataRow(false, true)]
        [DataTestMethod]
        public async Task InitializationTest(bool isNoPaymentMethods, bool useUsePaymentRequestApi)
        {
            // Arrange
            string requestId = useUsePaymentRequestApi ? "pr_39c93cc0-e855-42bc-8aca-183a572e14bc" : "cr_39c93cc0-e855-42bc-8aca-183a572e14bc";
            string requestContext = $"{{\"tenantId\":\"battle.net\",\"tenantCustomerId\":\"abc\",\"requestId\":\"{requestId}\",\"paymentAccountId\":\"123\",\"checkoutRequestId\":\"{requestId}\"}}";

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-request-context", requestContext }
            };

            if (useUsePaymentRequestApi)
            {
                headers.Add("x-ms-flight", "UsePaymentRequestApi");

                // Configure PartnerSettingsService response with paymentClientHandlePaymentCollection and componentSetting features
                string partnerSettingsResponse = @"{
                    ""Initialize"": {
                        ""template"": ""defaulttemplate"",
                        ""redirectionPattern"": ""fullPage"",
                        ""resources"": null,
                        ""features"": {
                            ""componentSetting"": {
                                ""applicableMarkets"": [],
                                ""displayCustomizationDetail"": [{
                                        ""components"": [""quickPayment"", ""ordersummary"", ""payment"", ""address"", ""profile"", ""confirm""]
                                }]
                            },
                            ""paymentClientHandlePaymentCollection"": {
                                ""applicableMarkets"": [],
                                ""displayCustomizationDetail"": null
                            }
                        }
                    },
                    ""default"": {
                        ""template"": ""defaulttemplate"",
                        ""redirectionPattern"": null,
                        ""resources"": null,
                        ""features"": null
                    }
                }";
                PXSettings.PartnerSettingsService.ArrangeResponse(partnerSettingsResponse);
            }

            if (isNoPaymentMethods)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            // Act
            HttpResponseMessage result = await SendRequestPXService(GlobalConstants.PaymentClientAPI.Initialize, HttpMethod.Post, new StringContent(requestContext, Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType), headers);

            // Assert
            Assert.IsNotNull(result);
            Assert.AreEqual(HttpStatusCode.OK, result.StatusCode, "Expected statuscode is not found");
            string response = await result.Content.ReadAsStringAsync();
            Assert.IsNotNull(response, "Initialize response string content should not be null");

            List<PIDLResource> pidls = JsonConvert.DeserializeObject<List<PIDLResource>>(response);
            Assert.IsNotNull(pidls, "Initialize description should not be null");

            var initializeContext = pidls[0].InitializeContext;
            Assert.IsNotNull(initializeContext, "Initialize description should not be null");

            Assert.IsNotNull(initializeContext.ComponentProps, "Components property should not be null");

            Assert.IsNotNull(initializeContext.SubmissionOrder, "SubmissionOrder should not be null");
            initializeContext.SubmissionOrder.ForEach(submitOrder =>
            {
                Assert.AreEqual(false, submitOrder.ValidateOnly);
            });

            Assert.IsNotNull(initializeContext.PidlDocOverrides, "PidlDocOverrides should not be null");
            Assert.AreEqual(!isNoPaymentMethods, initializeContext.SubmissionOrder.Any(so => so.InstanceName.Equals("list_pi", StringComparison.OrdinalIgnoreCase)));
            Assert.AreEqual(!isNoPaymentMethods, initializeContext.ComponentProps.ContainsKey("paymentProps"));
            
            // Verify components from componentSetting are present when UsePaymentRequestApi is enabled
            if (useUsePaymentRequestApi && !isNoPaymentMethods)
            {
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("orderSummaryProps"), "orderSummaryProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("addressProps"), "addressProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("profileProps"), "profileProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("confirmProps"), "confirmProps should be present");
            }
        }

        [DataRow(true, true, true, DisplayName = "ComputeTax true + flight enabled = keep components")]
        [DataRow(false, true, false, DisplayName = "ComputeTax false + flight enabled = remove components")]
        [DataRow(false, false, true, DisplayName = "ComputeTax false + flight disabled = keep components")]
        [DataRow(true, false, true, DisplayName = "ComputeTax true + flight disabled = keep components")]
        [DataTestMethod]
        public async Task Initialize_ComputeTaxAndFlight_Components(bool computeTax, bool enablePOCapabilitiesFlight, bool shouldKeepComponents)
        {
            // Arrange
            string requestUrl = "/v7.0/PaymentClient/Initialize";
            string partner = "candycrush";
            string flights = enablePOCapabilitiesFlight ? Flighting.Features.PXEnableUsePOCapabilities : string.Empty;
            string checkoutRequestId = "cr_" + Guid.NewGuid().ToString();

            var requestContext = new
            {
                TenantId = partner,
                RequestId = checkoutRequestId
            };

            var initializeData = new { };

            // Setup response for GetClientAction with appropriate ComputeTax value
            var poResponse = new
            {
                CheckoutRequestId = checkoutRequestId,
                PaymentMethodResults = new
                {
                    PaymentMethods = new[]
                    {
                        new
                        {
                            PaymentMethodType = "visa",
                            PaymentMethodFamily = "credit_card"
                        }
                    },
                    PaymentInstruments = new object[] { }
                },
                Capabilities = new
                {
                    ComputeTax = computeTax
                }
            };

            string expectedPOResponse = JsonConvert.SerializeObject(poResponse);
            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            if (!string.IsNullOrEmpty(flights))
            {
                headers.Add("x-ms-flight", flights);
            }

            // Act
            var response = await SendRequestPXService(
                requestUrl,
                HttpMethod.Post,
                new StringContent(JsonConvert.SerializeObject(initializeData), Encoding.UTF8, "application/json"),
                headers);

            // Assert
            Assert.AreEqual(HttpStatusCode.OK, response.StatusCode);
            var responseContent = await response.Content.ReadAsStringAsync();

            List<PIDLResource> pidls = ReadPidlResourceFromJson(responseContent);
            Assert.IsNotNull(pidls);
            Assert.AreEqual(1, pidls.Count);

            var pidlResource = pidls[0];
            Assert.IsNotNull(pidlResource.InitializeContext);

            // Verify OrderSummaryProps presence in componentProps
            Assert.AreEqual(
                shouldKeepComponents,
                pidlResource.InitializeContext.ComponentProps.ContainsKey("orderSummaryProps"),
                "OrderSummaryProps should " + (shouldKeepComponents ? "be present" : "be removed") + " based on ComputeTax and flight settings");
        }
        
        [DataRow("pr_39c93cc0-e855-42bc-8aca-183a572e14bc")]
        [DataRow("cr_39c93cc0-e855-42bc-8aca-183a572e14bc")]
        [TestMethod]
        public async Task PaymentRequestInitializeTest_clientActionsCall(string requestId)
        {
            // Arrange
            string url = "/v7.0/PaymentClient/initialize";

            string requestContext = "{\"tenantId\":\"battle.net\",\"tenantCustomerId\":\"abc\",\"requestId\":\"" + requestId + "\",\"paymentAccountId\":\"123\"}";

            HttpRequestMessage request = new HttpRequestMessage()
            {
                RequestUri = new Uri(GetPXServiceUrl(url)),
                Method = HttpMethod.Post,
                Content = new StringContent("{}", Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType)
            };

            request.Headers.Add("x-ms-request-context", requestContext);

            string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);

            bool clientActionsCall = false;
            PXSettings.PaymentOrchestratorService.PreProcess = (poServiceRequest) =>
            {
                clientActionsCall = true;
            };

            // Act
            var response = await PXClient.SendAsync(request);
            string result = await response.Content.ReadAsStringAsync();

            // Assert
            Assert.AreEqual(HttpStatusCode.OK, response.StatusCode, "Status code should be OK");
            JArray jArray = JArray.Parse(result);
            Assert.IsNotNull(jArray, "The response should be an array object");
            Assert.AreEqual(jArray.Count, 1, "The count of objects in the array should be 1");

            JObject jsonObject = (JObject)jArray[0];
            Assert.IsNotNull(jsonObject, "The object shouldn't be null");

            var intializeContextExists = jsonObject.ContainsKey("initializeContext");
            Assert.IsTrue(intializeContextExists, "The object should contain the key 'initializeContext'");
            Assert.IsTrue(clientActionsCall == requestId.StartsWith("cr_"), "The PO service should be called");
        }

        [DataRow(false, 2, "list_pi", "$15.45")]
        [DataRow(false, 4, "credit_card_visa_amex_mc_discover", "$--")]
        [DataRow(true, null, null, "$--")]
        [DataTestMethod]
        public async Task InitializationTestGetAllPIDL(bool isNoPaymentMethods, int paramsCount, string expectedValidation, string expectedTax)
        {
            // Arrange
            string requestContext = "{\"tenantId\":\"tn_6298182379cd44bfaac3ae3e96505175\",\"tenantCustomerId\":\"abc\",\"requestId\":\"cr_39c93cc0-e855-42bc-8aca-183a572e14bc\",\"paymentAccountId\":\"123\",\"checkoutRequestId\":\"cr_39c93cc0-e855-42bc-8aca-183a572e14bc\"}";

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", "PXEnableAllComponentDescriptions" },
                { "x-ms-request-context", requestContext }
            };

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (isNoPaymentMethods)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else if (expectedValidation.Equals("list_pi"))
            {
                string expectedListPIPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedListPIPOResponse);
            }
            else
            {
                string expectedNewUserPOResponse1 = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedNewUserPOResponse1);
            }

            // Act
            HttpResponseMessage result = await SendRequestPXService(GlobalConstants.PaymentClientAPI.Initialize, HttpMethod.Post, new StringContent(requestContext, Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType), headers);
                  
            // Assert
            Assert.IsNotNull(result);
            Assert.AreEqual(HttpStatusCode.OK, result.StatusCode, "Expected statuscode is not found");
            string response = await result.Content.ReadAsStringAsync();
            Assert.IsNotNull(response, "Initialize response string content should not be null");

            List<PIDLResource> pidls = JsonConvert.DeserializeObject<List<PIDLResource>>(response);
            Assert.IsNotNull(pidls, "Initialize description should not be null");

            // Assert - Initialise context details
            var initializeContext = pidls[0].InitializeContext;
            Assert.IsNotNull(initializeContext, "Initialize description should not be null");

            Assert.IsNotNull(initializeContext.ComponentProps, "Components property should not be null");

            Assert.IsNotNull(initializeContext.SubmissionOrder, "SubmissionOrder should not be null");
            initializeContext.SubmissionOrder.ForEach(submitOrder =>
            {
                Assert.AreEqual(false, submitOrder.ValidateOnly);
            });

            Assert.IsNotNull(initializeContext.PidlDocOverrides, "PidlDocOverrides should not be null");
            Assert.AreEqual(expectedValidation?.Equals("list_pi") ?? false ? true : false, initializeContext.SubmissionOrder.Any(so => so.InstanceName.Equals("list_pi", StringComparison.OrdinalIgnoreCase)));
            Assert.AreEqual(!isNoPaymentMethods, initializeContext.ComponentProps.ContainsKey("paymentProps"));

            // Assert - Components
            foreach (var component in initializeContext.Components)
            {
                var componentPidl = ReadPidlResourceFromJson(JsonConvert.SerializeObject(component.Value));
                ValidateOrderSummaryDescriptions(componentPidl, "https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png", "checkout", expectedTax, component.Key);
                ValidateQuickPaymentDescription(componentPidl, component: component.Key);
                ValidatePaymentDescriptions_Select(componentPidl, paramsCount, expectedValidation, component.Key);
                ValidateAddressDescriptions(componentPidl, component.Key);
                ValidatePaymentClientDescriptions(componentPidl, component.Key, component.Key);
            }
        }

        /// <summary>
        /// This CIT is designed to validate the PaymentClient/initialize endpoint when the UsePaymentRequestApi flight is enabled, as well as to verify the windowSize parameter for confirmProps.
        /// </summary>
        /// <param name="isPaymentClientHandlePaymentCollectionEnabled"></param>
        /// <param name="windowSizeValue"></param>
        /// <returns></returns>
        [DataRow(true, "1")]
        [DataRow(true, "02")]
        [DataRow(true, "03")]
        [DataRow(true, "4")]
        [DataRow(true, "5")]
        [DataRow(false, "1")]
        [DataRow(false, "02")]
        [DataRow(false, "03")]
        [DataRow(false, "4")]
        [DataRow(false, "5")]
        [TestMethod]
        public async Task PaymentRequestInitializeTest_clientActionsCall_WithUsePaymentRequestApi(bool isPaymentClientHandlePaymentCollectionEnabled, string windowSizeValue = null)
        {
            // Arrange
            string url = "/v7.0/PaymentClient/initialize";

            // Always use PR request ID regardless of isPaymentClientHandlePaymentCollectionEnabled
            string requestId = "pr_39c93cc0-e855-42bc-8aca-183a572e14bc";

            string requestContext = "{\"tenantId\":\"battle.net\",\"tenantCustomerId\":\"abc\",\"requestId\":\"" + requestId + "\",\"paymentAccountId\":\"123\"}";

            HttpRequestMessage request = new HttpRequestMessage()
            {
                RequestUri = new Uri(GetPXServiceUrl(url)),
                Method = HttpMethod.Post,
                Content = new StringContent("{}", Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType)
            };

            request.Headers.Add("x-ms-request-context", requestContext);
            request.Headers.Add("x-ms-flight", "UsePaymentRequestApi"); // Add the UsePaymentRequestApi flight

            // Configure PartnerSettingsService response with componentSetting feature and conditionally enable paymentClientHandlePaymentCollection
            string partnerSettingsResponse = @"{
                ""Initialize"": {
                    ""template"": ""defaulttemplate"",
                    ""redirectionPattern"": ""fullPage"",
                    ""resources"": null,
                    ""features"": {
                        ""componentSetting"": {
                            ""applicableMarkets"": [],
                            ""displayCustomizationDetail"": [{
                                    ""components"": [""quickPayment"", ""ordersummary"", ""payment"", ""address"", ""profile"", ""confirm""]
                            }]
                        }" +
                        (isPaymentClientHandlePaymentCollectionEnabled ? @",
                        ""paymentClientHandlePaymentCollection"": {
                            ""applicableMarkets"": [],
                            ""displayCustomizationDetail"": null
                        }" : string.Empty) + @"
                    }
                },
                ""default"": {
                    ""template"": ""defaulttemplate"",
                    ""redirectionPattern"": null,
                    ""resources"": null,
                    ""features"": null
                }
            }";
            PXSettings.PartnerSettingsService.ArrangeResponse(partnerSettingsResponse);

            string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);

            bool clientActionsCall = false;
            PXSettings.PaymentOrchestratorService.PreProcess = (poServiceRequest) =>
            {
                clientActionsCall = true;
                if (poServiceRequest.RequestUri.AbsolutePath.Contains("/clientactions"))
                {
                    clientActionsCall = poServiceRequest.RequestUri.AbsolutePath.Contains("/paymentRequests");
                }
            };

            // Act
            var payload = new
            {
                componentsData = new
                {
                    quickPayment = new
                    {
                        options = new
                        {
                            cornerRadius = "8px",
                            buttonColor = new
                            {
                                googlepay = "black",
                                applepay = "white"
                            },
                            buttonType = new
                            {
                                googlepay = "buy",
                                applepay = "plain"
                            }
                        }
                    },
                    confirm = new
                    {
                        windowSize = windowSizeValue
                    }
                }
            };

            request.Content = new StringContent(Newtonsoft.Json.JsonConvert.SerializeObject(payload), Encoding.UTF8, "application/json");

            var response = await PXClient.SendAsync(request);
            string result = await response.Content.ReadAsStringAsync();

            // Assert
            Assert.AreEqual(HttpStatusCode.OK, response.StatusCode, "Status code should be OK");
            JArray jArray = JArray.Parse(result);
            Assert.IsNotNull(jArray, "The response should be an array object");
            Assert.AreEqual(jArray.Count, 1, "The count of objects in the array should be 1");

            JObject jsonObject = (JObject)jArray[0];
            Assert.IsNotNull(jsonObject, "The object shouldn't be null");

            var initializeContextExists = jsonObject.ContainsKey("initializeContext");
            Assert.IsTrue(initializeContextExists, "The object should contain the key 'initializeContext'");

            // The behavior changes based on whether paymentClientHandlePaymentCollection is enabled:
            // - When enabled: The PO service should be called for PR requests
            // - When disabled: The PO service should NOT be called for PR requests
            bool shouldCallClientActions = isPaymentClientHandlePaymentCollectionEnabled;

            Assert.AreEqual(shouldCallClientActions, clientActionsCall, $"With paymentClientHandlePaymentCollection {(isPaymentClientHandlePaymentCollectionEnabled ? "enabled" : "disabled")}, " + $"the PO service {(shouldCallClientActions ? "should" : "should not")} be called for PR requests");

            // Check for componentSetting features in the response if there are components
            var initializeContext = jsonObject["initializeContext"] as JObject;
            if (initializeContext != null && initializeContext.ContainsKey("componentProps"))
            {
                var componentProps = initializeContext["componentProps"] as JObject;
                if (componentProps != null && componentProps.Count > 0)
                {
                    // Components should include confirm at minimum
                    Assert.IsTrue(componentProps.ContainsKey("confirmProps"), "confirmProps should be present");

                    // Other components may be present depending on the response
                    if (componentProps.Count > 1)
                    {
                        // Get confirmProps JObject
                        var confirmProps = componentProps["confirmProps"] as JObject;
                        Assert.IsNotNull(confirmProps, "confirmProps should not be null");

                        // Get parameters JObject
                        var parameters = confirmProps["parameters"] as JObject;
                        Assert.IsNotNull(parameters, "parameters in confirmProps should not be null");

                        // Assert windowSize value
                        Assert.AreEqual(windowSizeValue, parameters["windowSize"]?.ToString(), $"windowSize in confirmProps should be {windowSizeValue}");

                        // If we have more than just confirm, verify that the components specified in partnerSettingsResponse
                        // are included when they're applicable
                        var expectedComponents = new[] { "orderSummaryProps", "addressProps", "profileProps", "paymentProps", "quickPaymentProps" };
                        foreach (var component in expectedComponents)
                        {
                            if (componentProps.ContainsKey(component))
                            {
                                Assert.IsNotNull(componentProps[component], $"{component} should have a value if present");
                            }
                        }
                    }
                }
            }
        }

        [DataRow(false, 2, "list_pi", "$15.45")]
        [DataRow(false, 4, "credit_card_visa_amex_mc_discover", "$--")]
        [DataRow(true, null, null, "$--")]
        [DataTestMethod]
        public async Task InitializationTestGetAllPIDL_WithUsePaymentRequestApi_TakePayloadFromPO(bool isNoPaymentMethods, int paramsCount, string expectedValidation, string expectedTax)
        {
            // Arrange
            string requestId = "pr_39c93cc0-e855-42bc-8aca-183a572e14bc"; // Use PR request ID
            string requestContext = "{\"tenantId\":\"tn_6298182379cd44bfaac3ae3e96505175\",\"tenantCustomerId\":\"abc\",\"requestId\":\"" + requestId + "\",\"paymentAccountId\":\"123\",\"checkoutRequestId\":\"" + requestId + "\"}";
            string poPaymentRequestClientActionsString = string.Empty;

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", "PXEnableAllComponentDescriptions,UsePaymentRequestApi" }, // Add UsePaymentRequestApi flight
                { "x-ms-request-context", requestContext }
            };

            // Configure PartnerSettingsService response with paymentClientHandlePaymentCollection and componentSetting features
            string partnerSettingsResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"Initialize\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"fullPage\",\"resources\":null,\"features\":{\"componentSetting\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"components\":[\"quickPayment\",\"ordersummary\",\"payment\",\"address\",\"profile\",\"confirm\"]}]},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(partnerSettingsResponse);

            if (isNoPaymentMethods)
            {
                poPaymentRequestClientActionsString = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            }
            else if (expectedValidation.Equals("list_pi"))
            {
                poPaymentRequestClientActionsString = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            }
            else
            {
                poPaymentRequestClientActionsString = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            }

            var payload = new
            {
                paymentRequestClientActions = poPaymentRequestClientActionsString
            };

            // Track if PaymentOrchestratorService was called
            bool clientActionsCall = false;
            PXSettings.PaymentOrchestratorService.PreProcess = (poServiceRequest) =>
            {
                clientActionsCall = true;
            };

            // Act
            HttpResponseMessage result = await SendRequestPXService(GlobalConstants.PaymentClientAPI.Initialize, HttpMethod.Post, new StringContent(Newtonsoft.Json.JsonConvert.SerializeObject(payload), Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType), headers);

            // Assert
            Assert.IsNotNull(result);
            string response = await result.Content.ReadAsStringAsync();
            Assert.AreEqual(HttpStatusCode.OK, result.StatusCode, "Expected statuscode is not found");
            Assert.IsNotNull(response, "Initialize response string content should not be null");

            List<PIDLResource> pidls = JsonConvert.DeserializeObject<List<PIDLResource>>(response);
            Assert.IsNotNull(pidls, "Initialize description should not be null");

            // Assert - Initialise context details
            var initializeContext = pidls[0].InitializeContext;
            Assert.IsNotNull(initializeContext, "Initialize description should not be null");

            Assert.IsNotNull(initializeContext.ComponentProps, "Components property should not be null");

            Assert.IsNotNull(initializeContext.SubmissionOrder, "SubmissionOrder should not be null");
            initializeContext.SubmissionOrder.ForEach(submitOrder =>
            {
                Assert.AreEqual(false, submitOrder.ValidateOnly);
            });

            Assert.IsNotNull(initializeContext.PidlDocOverrides, "PidlDocOverrides should not be null");
            Assert.AreEqual(expectedValidation?.Equals("list_pi") ?? false ? true : false, initializeContext.SubmissionOrder.Any(so => so.InstanceName.Equals("list_pi", StringComparison.OrdinalIgnoreCase)));
            Assert.AreEqual(!isNoPaymentMethods, initializeContext.ComponentProps.ContainsKey("paymentProps"));

            // Since we have the UsePaymentRequestApi flag and paymentClientHandlePaymentCollection feature, 
            // we expect the PaymentOrchestratorService to be called with the PR request
            Assert.IsFalse(clientActionsCall, "The PO service should not be called if the call is from PO with paymentRequestClientActions");

            // Assert - Components from componentSetting should be present
            if (!isNoPaymentMethods)
            {
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("orderSummaryProps"), "orderSummaryProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("addressProps"), "addressProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("profileProps"), "profileProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("confirmProps"), "confirmProps should be present");
            }

            // Assert - Components
            foreach (var component in initializeContext.Components)
            {
                var componentPidl = ReadPidlResourceFromJson(JsonConvert.SerializeObject(component.Value));
                ValidateOrderSummaryDescriptions(componentPidl, "https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png", "checkout", expectedTax, component.Key);
                ValidateQuickPaymentDescription(componentPidl, component: component.Key);
                ValidatePaymentDescriptions_Select(componentPidl, paramsCount, expectedValidation, component.Key);
                ValidateAddressDescriptions(componentPidl, component.Key);
                ValidatePaymentClientDescriptions(componentPidl, component.Key, component.Key);
            }
        }

        [DataRow(false, 2, "list_pi", "$15.45")]
        [DataRow(false, 4, "credit_card_visa_amex_mc_discover", "$--")]
        [DataRow(true, null, null, "$--")]
        [DataTestMethod]
        public async Task InitializationTestGetAllPIDL_WithUsePaymentRequestApi(bool isNoPaymentMethods, int paramsCount, string expectedValidation, string expectedTax)
        {
            // Arrange
            string requestId = "pr_39c93cc0-e855-42bc-8aca-183a572e14bc"; // Use PR request ID
            string requestContext = "{\"tenantId\":\"tn_6298182379cd44bfaac3ae3e96505175\",\"tenantCustomerId\":\"abc\",\"requestId\":\"" + requestId + "\",\"paymentAccountId\":\"123\",\"checkoutRequestId\":\"" + requestId + "\"}";

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", "PXEnableAllComponentDescriptions,UsePaymentRequestApi" }, // Add UsePaymentRequestApi flight
                { "x-ms-request-context", requestContext }
            };

            // Configure PartnerSettingsService response with paymentClientHandlePaymentCollection and componentSetting features
            string partnerSettingsResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"Initialize\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"fullPage\",\"resources\":null,\"features\":{\"componentSetting\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"components\":[\"quickPayment\",\"ordersummary\",\"payment\",\"address\",\"profile\",\"confirm\"]}]},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(partnerSettingsResponse);

            if (isNoPaymentMethods)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else if (expectedValidation.Equals("list_pi"))
            {
                string expectedListPIPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedListPIPOResponse);
            }
            else
            {
                string expectedNewUserPOResponse1 = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedNewUserPOResponse1);
            }

            // Track if PaymentOrchestratorService was called
            bool clientActionsCall = false;
            PXSettings.PaymentOrchestratorService.PreProcess = (poServiceRequest) =>
            {
                clientActionsCall = true;
            };

            // Act
            HttpResponseMessage result = await SendRequestPXService(GlobalConstants.PaymentClientAPI.Initialize, HttpMethod.Post, new StringContent(requestContext, Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType), headers);

            // Assert
            Assert.IsNotNull(result);
            string response = await result.Content.ReadAsStringAsync();
            Assert.AreEqual(HttpStatusCode.OK, result.StatusCode, "Expected statuscode is not found");
            Assert.IsNotNull(response, "Initialize response string content should not be null");

            List<PIDLResource> pidls = JsonConvert.DeserializeObject<List<PIDLResource>>(response);
            Assert.IsNotNull(pidls, "Initialize description should not be null");

            // Assert - Initialise context details
            var initializeContext = pidls[0].InitializeContext;
            Assert.IsNotNull(initializeContext, "Initialize description should not be null");

            Assert.IsNotNull(initializeContext.ComponentProps, "Components property should not be null");

            Assert.IsNotNull(initializeContext.SubmissionOrder, "SubmissionOrder should not be null");
            initializeContext.SubmissionOrder.ForEach(submitOrder =>
            {
                Assert.AreEqual(false, submitOrder.ValidateOnly);
            });

            Assert.IsNotNull(initializeContext.PidlDocOverrides, "PidlDocOverrides should not be null");
            Assert.AreEqual(expectedValidation?.Equals("list_pi") ?? false ? true : false, initializeContext.SubmissionOrder.Any(so => so.InstanceName.Equals("list_pi", StringComparison.OrdinalIgnoreCase)));
            Assert.AreEqual(!isNoPaymentMethods, initializeContext.ComponentProps.ContainsKey("paymentProps"));

            // Since we have the UsePaymentRequestApi flag and paymentClientHandlePaymentCollection feature, 
            // we expect the PaymentOrchestratorService to be called with the PR request
            Assert.IsTrue(clientActionsCall, "The PO service should be called for PR requests with UsePaymentRequestApi and paymentClientHandlePaymentCollection enabled");

            // Assert - Components from componentSetting should be present
            if (!isNoPaymentMethods)
            {
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("orderSummaryProps"), "orderSummaryProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("addressProps"), "addressProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("profileProps"), "profileProps should be present");
                Assert.IsTrue(initializeContext.ComponentProps.ContainsKey("confirmProps"), "confirmProps should be present");
            }

            // Assert - Components
            foreach (var component in initializeContext.Components)
            {
                var componentPidl = ReadPidlResourceFromJson(JsonConvert.SerializeObject(component.Value));
                ValidateOrderSummaryDescriptions(componentPidl, "https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png", "checkout", expectedTax, component.Key);
                ValidateQuickPaymentDescription(componentPidl, component: component.Key);
                ValidatePaymentDescriptions_Select(componentPidl, paramsCount, expectedValidation, component.Key);
                ValidateAddressDescriptions(componentPidl, component.Key);
                ValidatePaymentClientDescriptions(componentPidl, component.Key, component.Key);
            }
        }

        [DataRow(false, 2, "list_pi", "$15.45")]
        [DataRow(false, 4, "credit_card_visa_amex_mc_discover", "$--")]
        [DataRow(true, null, null, "$--")]
        [DataTestMethod]
        public async Task InitializationTestGetAllPIDLWithPrefetcher(bool isNoPaymentMethods, int paramsCount, string expectedValidation, string expectedTax)
        {
            // Arrange
            string requestContext = "{\"tenantId\":\"tn_6298182379cd44bfaac3ae3e96505175\",\"tenantCustomerId\":\"abc\",\"requestId\":\"cr_39c93cc0-e855-42bc-8aca-183a572e14bc\",\"paymentAccountId\":\"123\",\"checkoutRequestId\":\"cr_39c93cc0-e855-42bc-8aca-183a572e14bc\"}";

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", "PXEnableAllComponentDescriptions,PXEnableCachedPrefetcherData" },
                { "x-ms-request-context", requestContext }
            };

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (isNoPaymentMethods)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else if (expectedValidation.Equals("list_pi"))
            {
                string expectedListPIPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedListPIPOResponse);
            }
            else
            {
                string expectedNewUserPOResponse1 = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedNewUserPOResponse1);
            }

            // Act
            HttpResponseMessage result = await SendRequestPXService(GlobalConstants.PaymentClientAPI.Initialize, HttpMethod.Post, new StringContent(requestContext, Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType), headers);

            // Assert
            Assert.IsNotNull(result);
            Assert.AreEqual(HttpStatusCode.OK, result.StatusCode, "Expected statuscode is not found");
            string response = await result.Content.ReadAsStringAsync();
            Assert.IsNotNull(response, "Initialize response string content should not be null");

            List<PIDLResource> pidls = ReadPidlResourceFromJson(response);
            Assert.IsNotNull(pidls, "Initialize description should not be null");

            // Assert - Initialise context details
            var initializeContext = pidls[0].InitializeContext;
            Assert.IsNotNull(initializeContext, "Initialize description should not be null");

            Assert.IsNotNull(initializeContext.ComponentProps, "Components property should not be null");

            Assert.IsNotNull(initializeContext.SubmissionOrder, "SubmissionOrder should not be null");
            initializeContext.SubmissionOrder.ForEach(submitOrder =>
            {
                Assert.AreEqual(false, submitOrder.ValidateOnly);
            });

            Assert.IsNotNull(initializeContext.PidlDocOverrides, "PidlDocOverrides should not be null");
            Assert.AreEqual(expectedValidation?.Equals("list_pi") ?? false ? true : false, initializeContext.SubmissionOrder.Any(so => so.InstanceName.Equals("list_pi", StringComparison.OrdinalIgnoreCase)));
            Assert.AreEqual(!isNoPaymentMethods, initializeContext.ComponentProps.ContainsKey("paymentProps"));

            if (!isNoPaymentMethods)
            {
                Assert.IsNotNull(initializeContext.CachedPrefetcherData, "CachedPrefetcherData should not be null");
            }

            // Assert - Components
            foreach (var component in initializeContext.Components)
            {
                var componentPidl = ReadPidlResourceFromJson(JsonConvert.SerializeObject(component.Value));
                ValidateOrderSummaryDescriptions(componentPidl, "https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png", "checkout", expectedTax, component.Key);
                ValidateQuickPaymentDescription(componentPidl, component: component.Key);
                ValidatePaymentDescriptions_Select(componentPidl, paramsCount, expectedValidation, component.Key);
                ValidateAddressDescriptions(componentPidl, component.Key);
                ValidatePaymentClientDescriptions(componentPidl, component.Key, component.Key);
            }
        }

        [DataRow(4, "credit_card_visa_amex_mc_discover", "{\"country\":\"us\",\"currency\":\"usd\",\"language\":\"en-us\",\"amount\":1.99,\"merchantAccountProfile\":{\"allowedPaymentMethods\":[\"visa\",\"amex\",\"mc\",\"discover\",\"googlepay\",\"applepay\"]},\"capabilities\":{\"computeTax\":false,\"sendEmail\":true,\"collectBillingAddress\":true}}")]
        [DataRow(4, "credit_card_visa_amex_mc_discover", "{\"Country\":\"us\",\"Currency\":\"usd\",\"Language\":\"en-us\",\"Amount\":1.99,\"MerchantAccountProfile\":{\"AllowedPaymentMethods\":[\"visa\",\"amex\",\"mc\",\"discover\",\"googlepay\",\"applepay\"]},\"Capabilities\":{\"computeTax\":false,\"sendEmail\":true,\"collectBillingAddress\":true}}")]
        [DataRow(4, "credit_card_visa_amex_mc_discover", "{\"TenantCustomerId\":\"2230263857\",\"PaymentRequestType\":\"purchase\",\"Language\":\"en-US\",\"Country\":\"US\",\"Currency\":\"USD\",\"Amount\":1.0,\"LineItems\":[{\"Description\":\"Daily Deal\",\"ItemName\":\"Daily Deal\",\"ChargeAmount\":1.0,\"Tax\":0.0,\"IsTaxInclusive\":true,\"Quantity\":1,\"PublisherName\":\"King\",\"ProductCode\":\"DAILY_DEAL_PACK5\",\"ContentType\":\"digitalgood\",\"ImageUri\":\"https://www.king.com/media/lrhleyvv/game-icon.webp?width=100&amp;height=100&amp;v=133770265291830000&amp;format=webp&amp;quality=85 \",\"Date\":\"2025-08-01T09:28:29.300846Z\"}],\"Metadata\":{\"OrderDate\":\"2025-08-01T09:24:08.5906084Z\",\"OrderId\":\"CFFC05B8-90BD-4E3F-831D-41D9AD1AB16A\",\"Purchaser\":\"2230263857-KING\"},\"Capabilities\":{\"ComputeTax\":false,\"SendEmail\":true,\"CollectBillingAddress\":true},\"MerchantAccountProfile\":{\"MerchantAccountName\":\"CandyCrushSaga\",\"SellerOfRecord\":null,\"AllowedPaymentMethods\":[\"Visa\",\"Mc\",\"Discover\",\"ApplePay\",\"GooglePay\"]},\"CustomerInfo\":{\"Email\":null}}")]
        [DataRow(4, "credit_card_visa_amex_mc_discover", "{\"TenantCustomerId\":\"123654\",\"PaymentRequestType\":\"purchase\",\"Language\":\"en-US\",\"Country\":\"US\",\"Currency\":\"USD\",\"Amount\":1.99,\"LineItems\":[{\"Description\":\"T...(9)\",\"ItemName\":\"Test Item Name\",\"ChargeAmount\":\"MASKED\",\"Tax\":0.0,\"IsTaxInclusive\":false,\"Quantity\":1,\"PublisherName\":\"King\",\"ProductCode\":\"ABCDSA\",\"ContentType\":\"digitalgood\",\"ImageUri\":\"https://example.com/image.png\",\"Date\":\"2025-08-27T21:44:44.1935843Z\"}],\"Metadata\":{\"OrderDate\":\"2025-08-27T21:44:42.1298993Z\",\"OrderId\":\"4EAE8BA6-5A50-4A5A-907A-D3B0F4166B26\",\"Purchaser\":\"123654-KING\"},\"Capabilities\":{\"ComputeTax\":false,\"SendEmail\":true,\"CollectBillingAddress\":true},\"MerchantAccountProfile\":{\"MerchantAccountName\":\"CandyCrushSaga\",\"SellerOfRecord\":null,\"AllowedPaymentMethods\":[\"Amex\",\"Visa\",\"Mc\",\"Discover\",\"ApplePay\",\"GooglePay\"]},\"CustomerInfo\":{\"Email \":null}}")]
        [DataTestMethod]
        public async Task InitializationTestGetAllPIDLWithPrefetcher_PIMS(int paramsCount, string expectedTax, string payload)
        {
            // Arrange
            string tenantGuid = "629818B3-79CD-44BF-AAC3-AE3E96505175";
            string requestId = "{paymentRequestId}";

            // Format the GUID without dashes and lowercase for tenantId
            string tenantId = $"tn_{tenantGuid.Replace("-", "").ToLower()}";
            string requestContext = $"{{\"tenantId\":\"{tenantId}\",\"tenantCustomerId\":\"abc\",\"requestId\":\"{requestId}\",\"paymentAccountId\":\"123\",\"paymentRequestId\":\"{requestId}\"}}";

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", "UsePaymentRequestApi,IncludePIDLDescriptionsV2,PXEnableAllComponentDescriptions,PXEnableCachedPrefetcherData" },
                { "x-ms-request-context", requestContext }
            };

            // Configure PartnerSettingsService response with paymentClientHandlePaymentCollection and componentSetting features
            string partnerSettingsResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"Initialize\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"fullPage\",\"resources\":null,\"features\":{\"componentSetting\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"components\":[\"quickPayment\",\"ordersummary\",\"payment\",\"address\",\"profile\",\"confirm\"]}]},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(partnerSettingsResponse);

            var getEligiblePMsResult = "{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}}";
            PXSettings.PimsService.ArrangeResponse(getEligiblePMsResult);

            // Act
            HttpResponseMessage result = await SendRequestPXService(GlobalConstants.PaymentClientAPI.Initialize, HttpMethod.Post, new StringContent(payload, Encoding.UTF8, PaymentConstants.HttpMimeTypes.JsonContentType), headers);

            // Assert
            Assert.IsNotNull(result);
            Assert.AreEqual(HttpStatusCode.OK, result.StatusCode, "Expected statuscode is not found");
            string response = await result.Content.ReadAsStringAsync();
            Assert.IsNotNull(response, "Initialize response string content should not be null");

            List<PIDLResource> pidls = ReadPidlResourceFromJson(response);
            Assert.IsNotNull(pidls, "Initialize description should not be null");

            // Assert - Initialise context details
            var initializeContext = pidls[0].InitializeContext;
            Assert.IsNotNull(initializeContext, "Initialize description should not be null");

            Assert.IsNotNull(initializeContext.ComponentProps, "Components property should not be null");

            Assert.IsNotNull(initializeContext.SubmissionOrder, "SubmissionOrder should not be null");
            initializeContext.SubmissionOrder.ForEach(submitOrder =>
            {
                Assert.AreEqual(false, submitOrder.ValidateOnly);
            });

            Assert.IsNotNull(initializeContext.PidlDocOverrides, "PidlDocOverrides should not be null");
        }
    }
}