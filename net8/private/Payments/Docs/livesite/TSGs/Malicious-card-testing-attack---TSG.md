# Malicious card testing attack - TSG

1. What is card testing attack?
    <span style="background-color:white">A card testing attack begins with fraud actors rapidly testing thousands of potential credit card credentials. They use various digital tools, including bots or scripts, that can cycle through hundreds or thousands of numbers on an ecommerce site.</span>
    <span style="background-color:white">The fraud actors’ main objective is to quickly identify a valid card and/or reveal a card’s missing security elements. This type of fraud is common across the entire credit card industry and&#160;</span>**<span style="background-color:white">does not necessarily mean that your card number has been compromised</span>**<span style="background-color:white">. Parameters like card expiry and CVV can prevent unauthorized charges. Unfortunately, processors and merchants do not always enforce these parameters.</span>
2. Sample Sev 3 generated by Metrics Advisor - [Incident 324732819](https://portal.microsofticm.com/imp/v3/incidents/details/324732819/home) : [Incident Report][High] PXSuccessRateThresholdSev3 - 2022-08-01 13:00:00 (UTC) - me|paymentinstrumentsexcontroller-post|commercialstores|&lt;-- EMPTY --&gt;|&lt;-- EMPTY --&gt;|&lt;-- EMPTY --&gt; and 1 more incidents

3. Below is a sample query for identifying the pattern for card testing attack.  Most of the traffic from the card testing attack would fail with a ValidationFailed error (400) from PIMS.

`cluster("pst").database("Prod").RequestTelemetry`

`| where TIMESTAMP > datetime(2022-07-05) and TIMESTAMP < datetime(2022-08-09)`

`| where name == "Microsoft.Commerce.Tracing.Sll.PXServiceIncomingOperation" and data_baseData_operationName == "PaymentInstrumentsExController-POST" and toint(data_baseData_protocolStatusCode) > 399`

`| extend url = parse_url(data_baseData_targetUri)`

`| extend params = url.["Query Parameters"]`

`| extend partner= tostring(params.partner), country = tostring(params.country)`

`| where country in ("me", "ve", "uk", "az", "sv", "gr", "ar") // Markets where we are seeing the card testing attacks`

`| where partner == "commercialstores" // Seems to be happening only from commercialstores partner`

`| project TIMESTAMP, cV, data_baseData_protocolStatusCode, data_baseData_targetUri, partner, country, data_RequestDetails, data_RequestHeader, data_ResponseDetails`

`| summarize RPH = count() by  country,bin(TIMESTAMP, 1h)`

`| render timechart with (title = "Failed ADD PI attempts (per hour) from commercialstores portals")`

![](/images/livesite/1-4fb5edc05635450d98988f3ca156e486.png)

Sample response from PIMS:

```
{"CorrelationId":"751021a4-220d-4213-9918-f140509a5f70","ErrorCode":"ValidationFailed","Message":"Try that again. Something happened on our end. Waiting a bit can help.","Source":"PXService","InnerError":{"ErrorCode":"ValidationFailed","Message":"The payment instrument cannot be validated. Please contact the payment processor for help.","Source":"PIManagementService","Details":[]}}
```

1. Reach out to the RISK team - Adam Reinhardt - adamrein@microsoft.com / Risk Data Science Commercial Team - rds\_commercial@microsoft.com

1. PX rejects some of these requests before sending to PIMS when the same account/IP used for card testing.
    Here is the query to find the requests that are blocked/rejected by PX

    `RequestTelemetry`
    `| where TIMESTAMP > ago(5d)`
    `and name == "Microsoft.Commerce.Tracing.Sll.PXServiceIncomingOperation"`
    `and data_baseData_operationName == "PaymentInstrumentsExController-POST" and data_PaymentMethodFamily == "credit_card" and data_baseData_protocolStatusCode == "400"`
    `| extend isBlockedByPX = data_Message contains "Caught and rejected by PXService"`
    `| where isBlockedByPX == true`
    `| summarize count(), dcount(data_AccountId) by bin(TIMESTAMP, 1d), data_Partner`
    `| render timechart`