## PX Traffic Drop - Tax ID flow
__PX Traffic Drop - Tax ID flow__

* __Background__: This TSG is for investigating the traffic drop of  Tax ID  flows operation names .The issue involves a significant drop in traffic across Tax ID flows, impacting the PX service.

* __Issue__: After get an IcM generated by PX Traffic Drop - Tax ID flows monitors, always start your investigation from IcM itself.  

* __Impact__: We've noticed that a particular operation name: TaxIdDescriptionsController-GET having traffic Drop.

* __SLA Definition__: The IcM should be mitigated in 3 days and resolved in 5 days for Sev3/Sev4.

* __Severity Level Explanation__:
    * __Sev4__ - Not urgent, no SLA impact such as routing maintenance.
    * __Sev3__ - Urgent or high business impact with no SLA impact such as service/Component below SLA, not impacting major or minor customer scenario.
    * __Sev2__ - Partial workflow or use case issue impacting service(s) or customer experience with errors or degraded performance.
    * __Sev1__ - Multi-region, multi-service, or major service degradation issue severely impacting customers.
    * __Sev0__ - Entire platform globally offline, with no workaround, directly impacting customers or an entire channel.
    

* __Steps to Investigate__:

    1.  Open the Monitor [Monitors | Jarvis](https://portal.microsoftgeneva.com/manage/monitors-direct?activity=monitor-home&account=paymentexperience-metrics-prod) and check for which operation name having traffic drop.
    2. Run the Kusto query below, to see the errors and adjust the Timestamp as needed(around 60 mins).

        Note:
        
        1. To run the below Kusto query, you need to have access to the PX Kusto Cluster. Kindly raise for an access here [PST Kusto Access Link](https://myaccess.microsoft.com/@microsoft.onmicrosoft.com#/access-packages/7fbe9cb6-00f3-4c98-9ed0-c9ff140f0f58)

        2. Connect to Azure VPN and open the Kusto explorer and a click on add connection with the Cluster Details - [Kusto Explorer](https://pst.kusto.windows.net)  to run the Kusto query

    3. __Modify Operation Name & Time__: Adjust the operation name and time based on the impacted operations and time window.
          * TaxIdDescriptionsController-GET

* __Sample Query__ 
    ```
   cluster("pst").database("Prod").RequestTelemetry 
   | where name == "Microsoft.Commerce.Tracing.Sll.PXServiceIncomingOperation" 
   | where data_baseData_operationName contains "TaxIdDescriptionsController-GET"
   //| where TIMESTAMP between (datetime(2025-02-05 21:45:55Z) .. datetime(2025-02-06 02:45:55Z)) //ICM Troubleshooting Information
   | project TIMESTAMP, name, cV, ext_cloud_location, data_baseData_protocolStatusCode, ext_cloud_name, data_baseData_latencyMs, data_baseData_operationName, data_baseData_targetUri, data_RequestHeader, data_RequestDetails, data_ResponseHeader, data_ResponseDetails, data_AccountId, data_Partner, data_PaymentMethodType, data_exception 
   | summarize RPS = count() by data_baseData_protocolStatusCode, bin(TIMESTAMP, 1m) 
   | render timechart 

    ```

   Or
   
* __Run the below query to check the system errors and user errors__

  ```
   let startTime = datetime(2025-03-01 20:56:21Z);  //ICM Troubleshooting Information
   let endTime = datetime(2025-03-01 21:06:21Z);
   let operationName = "TaxIdDescriptionsController-GET";
   GetPXReliabilityMetrics(startTime, endTime, "", operationName)
  ```

   Or
  
* __Run the below query to check the exact error.__   

  ```
   RequestTelemetry
   | where TIMESTAMP  between (datetime(2025-03-01 20:56:21Z) .. datetime(2025-03-01 21:56:21Z))
   | where (name == "Microsoft.Commerce.Tracing.Sll.PXServiceIncomingOperation" or name == "Microsoft.Commerce.Tracing.Sll.PXServiceOutgoingOperation")
   | where data_baseData_operationName == "TaxIdDescriptionsController-GET"
   | extend res = parse_json(data_ResponseDetails)
   | extend error = res['ErrorCode']
   | extend Message = res['Message']
   //| extend target = res['Target']
   | where data_baseData_protocolStatusCode startswith "4" //User Error
   //| where data_baseData_protocolStatusCode startswith "5" //System Error
   | project res['ErrorCode'],Message,TIMESTAMP,cV, name,data_ServerTraceId,data_RequestTraceId, data_baseData_callerName,  data_baseData_operationName,data_correlationId , data_baseData_protocolStatusCode,data_baseData_dependencyName,data_baseData_dependencyOperationName, data_baseData_latencyMs, data_baseData_targetUri, data_RequestDetails,data_ResponseDetails , data_ResponseHeader,data_RequestHeader, data_AccountId,  data_Country,data_faultDetail,data_AuthType,data_AttemptedAuthType
  ```

* __Mitigation Steps:__

    * __Transient Issue__ : If itâ€™s a transient issue, the IcM will be auto mitigated after 10 mins.
    * If the issue is not auto-mitigated, then we have to check the Monitor and Reliability Dashboard as per the time window [Service QoS | Jarvis](https://portal.microsoftgeneva.com/dashboard/paymentexperience-metrics-prod/Service%2520QoS?overrides=%5b%7b%22query%22:%22//*%5bid%3D%27OperationName%27%5d%22,%22key%22:%22value%22,%22replacement%22:%22TaxIdDescriptionsController-GET%22%7d,%7b%22query%22:%22//*%5bid%3D%27CloudLocation%27%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid%3D%27CloudRole%27%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid%3D%27RoleInstance%27%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid%3D%27CloudRoleInstance%27%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid%3D%27CallerName%27%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d%5d%20) and above Query's attached in the Investigation Steps and confirm if the traffic is back to normal. If not, Kindly contact to primary escalation point: PaymentExperience team.
    
* __Root Cause Analysis__:

  Check if the monitor for the operation name:  TaxIdDescriptionsController-GET is back to healthy or if it is continuously dropping. Then, work with the PaymentExperience team to identify the root cause and update the Root Cause Analysis in the IcM.
  
* __Verification Steps__:

  If the issue is auto-mitigated, then we have to check the [Monitors | Jarvis](https://portal.microsoftgeneva.com/manage/monitors-direct?activity=monitor-home&account=paymentexperience-metrics-prod) attached, go to the Monitor and confirm if the operation name: TaxIdDescriptionsController-GET is back to healthy. If not, Kindly contact to PaymentExperience team.

    * __Note__:
        1. we can either specify a specific value to get metrics only for that dimension value 
        2. we can specify empty value ("") to get all the metrics for various dimension values. 
        3. we can specify "*" to get aggregated metrics for that dimension.
             1. To get the time series/ trend for any metric we can use the 'binRange' parameter in the above function. 1. For example, to get the hourly trend for UserErrorRate for a particular dimension GetPXReliabilityMetrics(ago(24h), now(), 1h, "paymentinstrumentsexcontroller-post", "commercialstores", "*", "*", "*", "*") | project Timestamp, UserErrorRate | render timechart 
        4. We can use above two functions, to pretty much answer all the questions related to the error details, unique users, partners affected, error trend analysis, to make sure whether the issue is still ongoing or mitigated. 
            * If we do not see any spike in user errors or system errors and it's triggered due to overall low incoming traffic, and it creates noise, please reach out to Kowshik for tuning the monitor with suggested threshold details.
        5. Using the above details, analyze the impact and engage the correct team as mentioned at [livesite-sop.md - Repos (visualstudio.com)](https://microsoft.visualstudio.com/Universal%20Store/_git/SC.CSPayments.PX?path=/private/Payments/Docs/operations/livesite-sop.md&_a=preview). 
            1. If the issue is within PX service, see if the issue is limited to specific region. If so, we can either engage SRE oncall to take the impacted region offline, or get 'Traffic Manager Contributor' access to our PROD subscription using JIT and take the region offline. Our PROD Azure Traffic Manager is at [Azure Portal](https://portal.azure.com/#@mspmecloud.onmicrosoft.com/resource/subscriptions/9b6168fd-7d68-47e1-9c71-e51828aa62c0/resourceGroups/PX-Services-PROD-TM/providers/Microsoft.Network/trafficmanagerprofiles/paymentexperience-cp/overview). You need to use PME account and Yubi Key to login. 
            2. If the issue is caused by any recent flight changes, see if we need to turn off those flights. Refer to [feature-flighting.md - Repos (visualstudio.com)](https://microsoft.visualstudio.com/Universal%20Store/_git/SC.CSPayments.PX?path=/private/Payments/Docs/operations/feature-flighting.md&_a=preview) for flight config management 
            3. If the issue is within PX service and not specific to a region and not specific to any flight config, engage Eng Manager Oncall and see if any recent deployment needs to be rolled back.
  
* __Escalation Contact or Point-of-Contact (POC)__:
Kindly contact to primary escalation point: PaymentExperience team(__StoreCore-PST-PXService/pxoncall@microsoft.com__).

* __Acronyms or Glossary:__

    * PX: Payment Experience

    * SLA: Service Level Agreement

    * ICM: Incident Management

    * SRE: Site Reliability Engineering

    * JIT: Just-In-Time
    
    * PME: Payment Management Experience
        
