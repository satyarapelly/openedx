// <copyright company="Microsoft Corporation">Copyright (c) Microsoft 2022. All rights reserved.</copyright>

namespace CIT.PXService.Tests
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Net;
    using System.Net.Http;
    using System.Threading.Tasks;
    using Castle.Core.Internal;
    using global::Tests.Common.Model;
    using global::Tests.Common.Model.Pidl;
    using Microsoft.Commerce.Payments.PXService;
    using Microsoft.Commerce.Payments.PXService.Model.PaymentOrchestratorService;
    using Microsoft.Commerce.Payments.PXService.Model.PXInternal;
    using Microsoft.VisualStudio.TestTools.UnitTesting;
    using Newtonsoft.Json;
    using Constants = global::Tests.Common.Model.Pidl.Constants;

    [TestClass]
    public class DescriptionsControllerTests : TestBase
    {
        [TestInitialize]
        public void Startup()
        {
            PXSettings.AddressEnrichmentService.Responses.Clear();
            PXSettings.AccountsService.Responses.Clear();
            PXSettings.PimsService.Responses.Clear();
            PXSettings.TokenPolicyService.Responses.Clear();
            PXSettings.PurchaseService.Responses.Clear();
            PXSettings.PartnerSettingsService.Responses.Clear();
            PXSettings.OrchestrationService.Responses.Clear();
            PXSettings.IssuerService.Responses.Clear();
            PXSettings.CatalogService.Responses.Clear();

            PXSettings.AddressEnrichmentService.ResetToDefaults();
            PXSettings.AccountsService.ResetToDefaults();
            PXSettings.PimsService.ResetToDefaults();
            PXSettings.TokenPolicyService.ResetToDefaults();
            PXSettings.PurchaseService.ResetToDefaults();
            PXSettings.PartnerSettingsService.ResetToDefaults();
            PXSettings.OrchestrationService.ResetToDefaults();
            PXSettings.IssuerService.ResetToDefaults();
            PXSettings.CatalogService.ResetToDefaults();
            PXSettings.PaymentOrchestratorService.ResetToDefaults();
        }

        public static IReadOnlyList<string> TaxKeys
        {
            get
            {
                return new List<string>()
                {
                    "cart_tax",
                    "cart_subtotal",
                    "cart_total"
                };
            }
        }

        [DataRow("candycrush", "payment", "add", null, "credit_card", null, null, 0, null)]
        [DataRow("candycrush", "payment", "add", null, "credit_card", null, "paymentMethod", 4, null)]
        [DataRow("candycrush", "payment", "add", null, "credit_card", "visa,mc", "paymentMethod", 2, null)]
        [DataRow("candycrush", "payment", "add", null, "credit_card", "visa", "paymentMethod", 1, null)]
        [DataTestMethod]
        public async Task GetPaymentClientDescriptions(string partner, string component, string operation, string scenario, string family, string type, string expectedIdentity, int pidlCount, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component={0}&operation={1}&scenario={2}&partner={3}&family={4}&type={5}", component, operation, scenario, partner, family, type);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (pidlCount == 0)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, pidlCount == 0 ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");

            if (pidlCount > 0)
            {
                if (component.Equals("address", StringComparison.OrdinalIgnoreCase))
                {
                    Assert.AreEqual(expectedValidation, pidls[0].GetPropertyDescriptionByPropertyName("show_summary").Validation?.Regex, "Show summary validation is not expected");
                    Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["resource_id"].ToLower(), "PIDL resource id not expected");
                }
                else
                {
                    Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL idenity not expected");
                }
            }
        }

        [DataRow("candycrush", "payment", "add", null, "credit_card", null, null, 0, null)]
        [DataRow("candycrush", "payment", "add", null, "credit_card", null, "paymentMethod", 4, null)]
        [DataRow("candycrush", "payment", "add", null, "credit_card", "visa,mc", "paymentMethod", 2, null)]
        [DataRow("candycrush", "payment", "add", null, "credit_card", "visa", "paymentMethod", 1, null)]
        [DataTestMethod]
        public async Task GetPaymentClientDescriptions_UsePaymentRequestApi(string partner, string component, string operation, string scenario, string family, string type, string expectedIdentity, int pidlCount, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi"; // Include UsePaymentRequestApi flight
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component={0}&operation={1}&scenario={2}&partner={3}&family={4}&type={5}", component, operation, scenario, partner, family, type);

            // Configure PartnerSettingsService with paymentClientHandlePaymentCollection feature
            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":true,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            // Use PaymentRequestClientActions instead of CheckoutRequestClientActions
            string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"paymentRequestId\":\"pr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"status\":\"PendingClientAction\",\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"clientActions\":[],\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}]}";

            if (pidlCount == 0)
            {
                expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            }

            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);

            // Use payment request ID instead of checkout request ID
            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, pidlCount == 0 ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");

            if (pidlCount > 0)
            {
                Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

                if (component.Equals("address", StringComparison.OrdinalIgnoreCase))
                {
                    Assert.AreEqual(expectedValidation, pidls[0].GetPropertyDescriptionByPropertyName("show_summary").Validation?.Regex, "Show summary validation is not expected");
                    Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["resource_id"].ToLower(), "PIDL resource id not expected");
                }
                else
                {
                    Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");
                }
            }

            PXSettings.PartnerSettingsService.ResetToDefaults();
            PXSettings.PaymentOrchestratorService.ResetToDefaults();
            PXFlightHandler.ResetToDefault();
        }

        [DataRow("candycrush", "checkout", "https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png")]
        [DataTestMethod]
        public async Task GetOrderSummaryDescriptions(string partner, string expectedIdentity, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=ordersummary&operation=show&partner={0}", partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            ValidateOrderSummaryDescriptions(pidls, expectedValidation, expectedIdentity);
        }

        [DataRow("candycrush", "checkout", "https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png")]
        [DataTestMethod]
        public async Task GetOrderSummaryDescriptions_UsePaymentRequestApi(string partner, string expectedIdentity, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi"; // Include UsePaymentRequestApi flight
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=ordersummary&operation=show&partner={0}", partner);

            // Configure PartnerSettingsService with paymentClientHandlePaymentCollection feature
            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[]},\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":true,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[]}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);

            // Use payment request ID instead of checkout request ID
            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            ValidateOrderSummaryDescriptions(pidls, expectedValidation, expectedIdentity);

            // Clean up after test
            PXSettings.PartnerSettingsService.ResetToDefaults();
            PXSettings.PaymentOrchestratorService.ResetToDefaults();
            PXFlightHandler.ResetToDefault();
        }

        [DataRow("candycrush", "profile")]
        [DataTestMethod]
        public async Task GetProfileDescriptions(string partner, string expectedIdentity)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=profile&operation=Add&partner={0}", partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            ValidatePaymentClientDescriptions(pidls, expectedIdentity);
        }

        [DataRow("candycrush", "profile")]
        [DataTestMethod]
        public async Task GetProfileDescriptions_UsePaymentRequestApi(string partner, string expectedIdentity)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi"; // Include UsePaymentRequestApi flight
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=profile&operation=Add&partner={0}", partner);

            // Configure PartnerSettingsService with paymentClientHandlePaymentCollection feature
            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":true,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            // Use payment request ID instead of checkout request ID
            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

            // Verify that save and cancel buttons are hidden
            var saveButton = pidls[0].GetDisplayHintById("saveButton") as ButtonDisplayHint;
            Assert.IsNotNull(saveButton, "Save button should not be null");
            Assert.IsTrue(saveButton.IsHidden, "Save button should be hidden");

            var cancelButton = pidls[0].GetDisplayHintById("cancelButton") as ButtonDisplayHint;
            Assert.IsNotNull(cancelButton, "Cancel button should not be null");
            Assert.IsTrue(cancelButton.IsHidden, "Cancel button should be hidden");

            // Clean up after test
            PXSettings.PartnerSettingsService.ResetToDefaults();
            PXFlightHandler.ResetToDefault();
        }

        [DataRow("candycrush", "confirm")]
        [DataTestMethod]
        public async Task GetConfirmDescriptions(string partner, string expectedIdentity)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=confirm&operation=add&partner={0}", partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            ValidatePaymentClientDescriptions(pidls, expectedIdentity);
        }

        [DataRow("candycrush", "confirm")]
        [DataTestMethod]
        public async Task GetConfirmDescriptions_UsePaymentRequestApi(string partner, string expectedIdentity)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=confirm&operation=add&partner={0}", partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":true,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            ValidatePaymentClientDescriptions(pidls, expectedIdentity);
        }

        [DataRow("candycrush", "54caf9ba-184f-4d50-8728-14aa738c92ae", "paymentinstrument")]
        [DataTestMethod]
        public async Task GetDeleteDescriptions(string partner, string piid, string expectedIdentity)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=delete&partner={0}&piid={1}", partner, piid);

            string expectedPSSResponse = "{\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

            var piIdProperty = pidls[0].DataDescription["piid"] as PropertyDescription;
            Assert.IsNotNull(piIdProperty, "PiId property is expected to be not null");
            Assert.AreEqual(piid.ToLower(), piIdProperty.DefaultValue.ToString().ToLower(), "piID property value not expected");

            var deleteButton = pidls[0].GetDisplayHintById("yesButton") as ButtonDisplayHint;
            Assert.IsNotNull(deleteButton, "Delete button is expected to be not null");

            var restLink = JsonConvert.DeserializeObject<RestLink>(JsonConvert.SerializeObject(deleteButton.Action.Context));
            Assert.IsNotNull(restLink, "Delete button action context is expected to be not null");
            Assert.IsTrue(restLink.Href.Contains("removeEligiblePaymentmethods"), "Delete button URL expected to be removeEligiblePaymentmethods");
        }

        [DataRow("candycrush", "54caf9ba-184f-4d50-8728-14aa738c92ae", "paymentinstrument")]
        [DataTestMethod]
        public async Task GetDeleteDescriptions_UsePaymentRequestApi(string partner, string piid, string expectedIdentity)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=delete&partner={0}&piid={1}", partner, piid);

            string expectedPSSResponse = "{\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

            var piIdProperty = pidls[0].DataDescription["piid"] as PropertyDescription;
            Assert.IsNotNull(piIdProperty, "PiId property is expected to be not null");
            Assert.AreEqual(piid.ToLower(), piIdProperty.DefaultValue.ToString().ToLower(), "piID property value not expected");

            var deleteButton = pidls[0].GetDisplayHintById("yesButton") as ButtonDisplayHint;
            Assert.IsNotNull(deleteButton, "Delete button is expected to be not null");

            var restLink = JsonConvert.DeserializeObject<RestLink>(JsonConvert.SerializeObject(deleteButton.Action.Context));
            Assert.IsNotNull(restLink, "Delete button action context is expected to be not null");
            Assert.IsTrue(restLink.Href.Contains("removeEligiblePaymentmethods"), "Delete button URL expected to be removeEligiblePaymentmethods");
        }

        [DataRow("candycrush", "payment", "add", null, "credit_card", null, null, 0, null, "PXAddCCDfpIframe")]
        [DataRow("candycrush", "payment", "add", null, "credit_card", null, "paymentMethod", 4, null, "PXAddCCDfpIframe")]
        [DataRow("candycrush", "payment", "add", null, "credit_card", null, "paymentMethod", 4, null, null)]
        [DataRow("candycrush", "confirm", "Add", null, null, null, "confirm", 1, null, "PXConfirmDfpIframe")]
        [DataRow("candycrush", "confirm", "Add", null, null, null, "confirm", 1, null, null)]
        [DataTestMethod]
        public async Task GetPaymentClientDescriptions_AddCC_DFPIframe(string partner, string component, string operation, string scenario, string family, string type, string expectedIdentity, int pidlCount, string expectedValidation, string dfpFlight)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            if (!string.IsNullOrEmpty(dfpFlight))
            {
                flights += "," + dfpFlight;
            }

            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component={0}&operation={1}&scenario={2}&partner={3}&family={4}&type={5}", component, operation, scenario, partner, family, type);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (pidlCount == 0)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, pidlCount == 0 ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");

            if (pidlCount > 0)
            {
                pidls.ForEach(pidl =>
                {
                    var dfpIframe = pidl.GetDisplayHintById("dfpIframe");
                    if (!string.IsNullOrEmpty(dfpFlight))
                    {
                        Assert.IsNotNull(dfpIframe, "DFP iframe should be present");
                    }
                    else
                    {
                        Assert.IsNull(dfpIframe, "DFP iframe should NOT be present");
                    }
                });
            }
        }

        [DataRow("candycrush", "payment", "add", null, "credit_card", null, null, 0, null, "PXAddCCDfpIframe")]
        [DataRow("candycrush", "payment", "add", null, "credit_card", null, "paymentMethod", 4, null, "PXAddCCDfpIframe")]
        [DataRow("candycrush", "payment", "add", null, "credit_card", null, "paymentMethod", 4, null, null)]
        [DataRow("candycrush", "confirm", "Add", null, null, null, "confirm", 1, null, "PXConfirmDfpIframe")]
        [DataRow("candycrush", "confirm", "Add", null, null, null, "confirm", 1, null, null)]
        [DataTestMethod]
        public async Task GetPaymentClientDescriptions_AddCC_DFPIframe_UsePaymentRequestApi(string partner, string component, string operation, string scenario, string family, string type, string expectedIdentity, int pidlCount, string expectedValidation, string dfpFlight)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            if (!string.IsNullOrEmpty(dfpFlight))
            {
                flights += "," + dfpFlight;
            }

            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component={0}&operation={1}&scenario={2}&partner={3}&family={4}&type={5}", component, operation, scenario, partner, family, type);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"handlepaymentchallenge\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"threeDSOne\":{\"applicableMarkets\":[\"in\"],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":false,\"pxEnableIndia3DS1Challenge\":true,\"india3dsEnableForBilldesk\":true,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"PSD2\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":null,\"dataSource\":null,\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":true,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (pidlCount == 0)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, pidlCount == 0 ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");

            if (pidlCount > 0)
            {
                pidls.ForEach(pidl =>
                {
                    var dfpIframe = pidl.GetDisplayHintById("dfpIframe");
                    if (!string.IsNullOrEmpty(dfpFlight))
                    {
                        Assert.IsNotNull(dfpIframe, "DFP iframe should be present");
                    }
                    else
                    {
                        Assert.IsNull(dfpIframe, "DFP iframe should NOT be present");
                    }
                });
            }
        }

        [DataRow("candycrush", null, 1)]
        [DataRow("candycrush", "list_pi", 2)]
        [DataTestMethod]
        public async Task GetAddressDescriptions_Checkout(string partner, string scenario, int pidlCount)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=address&operation=Add&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            TestBase.ValidateAddressDescriptions(pidls);
        }

        [DataRow("candycrush", null, 1)]
        [DataRow("candycrush", "list_pi", 2)]
        [DataTestMethod]
        public async Task GetAddressDescriptions_Checkout_UsePaymentRequestApi(string partner, string scenario, int pidlCount)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=address&operation=Add&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            TestBase.ValidateAddressDescriptions(pidls);
        }

        [DataRow("candycrush", "list_pi", 2, true)]
        [DataRow("candycrush", "list_pi", 2, false)]
        [DataRow("candycrush", "", 1, true)]
        [DataRow("candycrush", "", 1, false)]
        [DataTestMethod]
        public async Task GetAddressDescriptions_Checkout_ComputeTax(string partner, string scenario, int pidlCount, bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=address&operation=Add&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            if (computeTax)
            {
                flights += ",PXEnableUsePOCapabilities";
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            pidls.ForEach(pidl =>
            {
                var cartTaxDisplayHint = pidl.GetDisplayHintById("cartTax") as PropertyDisplayHint;
                var cartTotalDisplayHint = pidl.GetDisplayHintById("cartTotal") as PropertyDisplayHint;
                var cartSubTotalDisplayHint = pidl.GetDisplayHintById("cartSubtotal") as PropertyDisplayHint;

                Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartSubTotalDisplayHint should not be null if computeTax is true");

                var cartTaxPropertyHint = pidl.GetPropertyDescriptionByPropertyName("cart_tax") as PropertyDescription;
                var cartTotalPropertyHint = pidl.GetPropertyDescriptionByPropertyName("cart_total") as PropertyDescription;
                var cartSubTotalPropertyHint = pidl.GetPropertyDescriptionByPropertyName("cart_subtotal") as PropertyDescription;

                Assert.AreEqual(cartTaxPropertyHint != null, computeTax, "cartTaxPropertyHint should not be null if computeTax is false");
                Assert.AreEqual(cartTotalPropertyHint != null, computeTax, "cartTotalPropertyHint should not be null if computeTax false");
                Assert.AreEqual(cartSubTotalPropertyHint != null, computeTax, "cartSubTotalPropertyHint should not be null if computeTax false");
            });

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            TestBase.ValidateAddressDescriptions(pidls);
        }

        [DataRow("candycrush", "list_pi", 2, true)]
        [DataRow("candycrush", "list_pi", 2, false)]
        [DataRow("candycrush", "", 1, true)]
        [DataRow("candycrush", "", 1, false)]
        [DataTestMethod]
        public async Task GetAddressDescriptions_Checkout_ComputeTax_UsePaymentRequestApi(string partner, string scenario, int pidlCount, bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=address&operation=Add&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enablePlaceholder\":{\"applicableMarkets\":[]},\"singleMarketDirective\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"customizeAddressForm\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"moveCardNumberBeforeCardHolderName\":false,\"moveOrganizationNameBeforeEmailAddress\":false,\"moveLastNameBeforeFirstName\":null,\"setSaveButtonDisplayContentAsNext\":false,\"removeStarRequiredTextGroup\":null,\"updateCvvChallengeTextForGCO\":false,\"enableIsSelectPMskippedValue\":null,\"enableCountryAddorUpdateCC\":false,\"hideCountryDropdown\":null,\"hideFirstAndLastNameForCompletePrerequisites\":false,\"hideAddCreditDebitCardHeading\":false,\"updatePaymentMethodHeadingTypeToText\":null,\"removeAddCreditDebitCardHeading\":null,\"setGroupedSelectOptionTextBeforeLogo\":null,\"setSelectPMWithLogo\":null,\"useTextForCVVHelpLink\":null,\"cvvDisplayHelpPosition\":null,\"matchSelectPMMainPageStructureForSubPage\":null,\"useFixedSVGForMC\":null,\"enableIndia3dsForNonZeroPaymentTransaction\":null,\"pxEnableIndia3DS1Challenge\":null,\"india3dsEnableForBilldesk\":null,\"usePSSForPXFeatureFlighting\":null,\"enableSecureFieldAddCC\":false,\"setSaveButtonDisplayContentAsBook\":false,\"removeCancelButton\":false,\"removeSelectPiEditButton\":null,\"removeSelectPiNewPaymentMethodLink\":null,\"removeSpaceInPrivacyTextGroup\":null,\"setBackButtonDisplayContentAsCancel\":false,\"setPrivacyStatementHyperLinkDisplayToButton\":null,\"hidePaymentSummaryText\":false,\"hidepaymentOptionSaveText\":false,\"addressType\":\"billing\",\"dataSource\":\"jarvis\",\"submitActionType\":null,\"fieldsToBeHidden\":null,\"fieldsToBeEnabled\":null,\"fieldsToMakeRequired\":null,\"fieldsToBeRemoved\":null,\"removeOptionalTextFromFields\":null,\"psd2IgnorePIAuthorization\":null,\"addressSuggestionMessage\":false,\"updateAccessibilityNameWithPosition\":null,\"disableSelectPiRadioOption\":null,\"updateSelectPiButtonText\":null,\"removeGroupForExpiryMonthAndYear\":null,\"useAddressDataSourceForUpdate\":null,\"disableCountryDropdown\":null,\"ungroupAddressFirstNameLastName\":null,\"endPoint\":null,\"operation\":null,\"profileType\":null,\"dataFieldsToRemoveFromPayload\":null,\"dataFieldsToRemoveFullPath\":null,\"convertProfileTypeTo\":null,\"fieldsToBeDisabled\":null,\"hidePaymentMethodHeading\":null,\"hideChangeSettingText\":null,\"removeEwalletYesButtons\":null,\"removeEwalletBackButtons\":null,\"removeDefaultStyleHints\":null,\"useSuggestAddressesTradeAVSV1Scenario\":null,\"addCCAddressValidationPidlModification\":null,\"verifyAddressPidlModification\":null,\"displayTagsToBeRemoved\":null,\"replaceContextInstanceWithPaymentInstrumentId\":null,\"enablePlaceholder\":null,\"hideAcceptCardMessage\":null,\"addAccessibilityNameExpressionToNegativeValue\":null,\"removeAnotherDeviceTextFromShortUrlInstruction\":null,\"displayShortUrlAsHyperlink\":null,\"hideAddressCheckBoxIfAddressIsNotPrefilledFromServer\":null,\"fieldsToSetIsSubmitGroupFalse\":null,\"removeMicrosoftPrivacyTextGroup\":null,\"hideCardLogos\":null,\"hideAddress\":null,\"addCancelButton\":false,\"displayShortUrlAsVertical\":null,\"setSubmitURLToEmptyForTaxId\":null,\"addressSuggestion\":null,\"updateXboxElementsAccessibilityHints\":null,\"setCancelButtonDisplayContentAsBack\":false,\"setButtonDisplayContent\":null,\"updateConsumerProfileSubmitLinkToJarvisPatch\":null,\"removeDataSourceResources\":null,\"useIFrameForPiLogOn\":null,\"removeAddressFormHeading\":null,\"displayAccentBorderOnButtonFocus\":null,\"addStyleHints\":null,\"removeStyleHints\":null,\"removeAcceptCardMessage\":null,\"addAllFieldsRequiredText\":null}]},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            if (computeTax)
            {
                flights += ",PXEnableUsePOCapabilities";
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            pidls.ForEach(pidl =>
            {
                var cartTaxDisplayHint = pidl.GetDisplayHintById("cartTax") as PropertyDisplayHint;
                var cartTotalDisplayHint = pidl.GetDisplayHintById("cartTotal") as PropertyDisplayHint;
                var cartSubTotalDisplayHint = pidl.GetDisplayHintById("cartSubtotal") as PropertyDisplayHint;

                Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartSubTotalDisplayHint should not be null if computeTax is true");

                var cartTaxPropertyHint = pidl.GetPropertyDescriptionByPropertyName("cart_tax") as PropertyDescription;
                var cartTotalPropertyHint = pidl.GetPropertyDescriptionByPropertyName("cart_total") as PropertyDescription;
                var cartSubTotalPropertyHint = pidl.GetPropertyDescriptionByPropertyName("cart_subtotal") as PropertyDescription;

                Assert.AreEqual(cartTaxPropertyHint != null, computeTax, "cartTaxPropertyHint should not be null if computeTax is false");
                Assert.AreEqual(cartTotalPropertyHint != null, computeTax, "cartTotalPropertyHint should not be null if computeTax false");
                Assert.AreEqual(cartSubTotalPropertyHint != null, computeTax, "cartSubTotalPropertyHint should not be null if computeTax false");
            });

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            TestBase.ValidateAddressDescriptions(pidls);
        }

        [DataRow("candycrush", true, 2, "list_pi", true)]
        [DataRow("candycrush", false, 2, "list_pi", true)]
        [DataRow("candycrush", true, 1, "", true)]
        [DataRow("candycrush", false, 1, "", true)]
        [DataRow("candycrush", true, 2, "list_pi", false)]
        [DataRow("candycrush", false, 2, "list_pi", false)]
        [DataRow("candycrush", true, 1, "", false)]
        [DataRow("candycrush", false, 1, "", false)]
        [DataTestMethod]
        public async Task GetAddressDescriptions_EnableAddressValidationOnFocusOut(string partner, bool enableFeature, int pidlCount, string scenario, bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=address&operation=Add&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse;
            if (enableFeature)
            {
                expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enablePaymentRequestAddressValidation\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            }
            else
            {
                expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            }

            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (computeTax)
            {
                flights += ",PXEnableUsePOCapabilities";
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"test@example.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"OrderId\":\"test123\",\"OrderDate\":\"January 18 2023\"},\"lineItems\":[{\"imageUri\":\"https://example.com/image.png\",\"description\":\"Sample Item\",\"itemName\":\"Test Item\",\"chargeAmount\":150.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"Test Publisher\",\"productCode\":\"P001\",\"contentType\":\"Digital\"}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"test@example.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"OrderId\":\"test123\",\"OrderDate\":\"January 18 2023\"},\"lineItems\":[{\"imageUri\":\"https://example.com/image.png\",\"description\":\"Sample Item\",\"itemName\":\"Test Item\",\"chargeAmount\":150.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"Test Publisher\",\"productCode\":\"P001\",\"contentType\":\"Digital\"}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidls should not be null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            TestBase.ValidateAddressDescriptions(pidls);

            // Verify tax-related display hints
            pidls.ForEach(pidl =>
            {
                var cartTaxDisplayHint = pidl.GetDisplayHintById("cartTax") as PropertyDisplayHint;
                var cartTotalDisplayHint = pidl.GetDisplayHintById("cartTotal") as PropertyDisplayHint;
                var cartSubTotalDisplayHint = pidl.GetDisplayHintById("cartSubtotal") as PropertyDisplayHint;

                Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartSubTotalDisplayHint != null, computeTax, "cartSubTotalDisplayHint should not be null if computeTax is true");
            });

            pidls.ForEach(pidl =>
            {
                // Test address fields for onFocusOut event and check for nextAction
                AddressDescription.AddressDataDescriptions.ToList().ForEach(dataDescriptionId =>
                {
                    if (pidl.DataDescription.ContainsKey(dataDescriptionId))
                    {
                        var addressDisplayHint = pidl.GetDisplayHintByPropertyName(dataDescriptionId) as PropertyDisplayHint;
                        Assert.IsNotNull(addressDisplayHint, "Address display hint should not be null");
                        Assert.IsNotNull(addressDisplayHint.Onfocusout, "OnFocusOut event should be present");

                        if (!computeTax)
                        {
                            // When computeTax is false, verify nextAction is present and is partnerActionWithPidlPayload type
                            Assert.IsNotNull(addressDisplayHint.Onfocusout.NextAction, "NextAction should be present when computeTax is false");
                            Assert.AreEqual(DisplayHintActionType.partnerActionWithPidlPayload.ToString(), addressDisplayHint.Onfocusout.NextAction.ActionType, "NextAction should be partnerActionWithPidlPayload when computeTax is false");

                            // Verify the href contains ModernValidate for address validation
                            if (enableFeature)
                            {
                                var eventContext = JsonConvert.DeserializeObject<EventContext>(
                                    JsonConvert.SerializeObject(addressDisplayHint.Onfocusout.Context));
                                Assert.IsTrue(eventContext.Href.Contains("ModernValidate"), "Href should contain ModernValidate when feature is enabled");
                                Assert.IsTrue(eventContext.Href.Contains("suggestAddressesTradeAVSUsePidlModal"), "Href should contain suggestAddressesTradeAVSUsePidlModal scenario");
                            }
                        }
                        else if (enableFeature)
                        {
                            // When feature is enabled and computeTax is true, verify nextAction is not present, and href contains suggestAddressesTradeAVSUsePidlModal
                            Assert.IsNull(addressDisplayHint.Onfocusout.NextAction, "NextAction should be present when feature is enabled");

                            // Check the href contains ModernValidate
                            var eventContext = JsonConvert.DeserializeObject<EventContext>(
                                JsonConvert.SerializeObject(addressDisplayHint.Onfocusout.Context));
                            Assert.IsTrue(eventContext.Href.Contains("ModernValidate"), "Href should contain ModernValidate");
                            Assert.IsTrue(eventContext.Href.Contains("suggestAddressesTradeAVSUsePidlModal"), "Href should contain suggestAddressesTradeAVSUsePidlModal scenario");
                        }
                        else
                        {
                            // When feature is disabled and computeTax is true, verify nextAction is not present
                            Assert.IsNull(addressDisplayHint.Onfocusout.NextAction, "NextAction should not be present when feature is disabled and computeTax is true");

                            // Verify the context contains CheckoutRequestsEx
                            var eventContext = JsonConvert.DeserializeObject<EventContext>(
                                JsonConvert.SerializeObject(addressDisplayHint.Onfocusout.Context));
                            Assert.IsTrue(eventContext.Href.Contains("CheckoutRequestsEx"), "Href should contain CheckoutRequestsEx");
                        }
                    }
                });
            });
        }

        [DataRow("candycrush", true, 2, "list_pi", true)]
        [DataRow("candycrush", false, 2, "list_pi", true)]
        [DataRow("candycrush", true, 1, "", true)]
        [DataRow("candycrush", false, 1, "", true)]
        [DataRow("candycrush", true, 2, "list_pi", false)]
        [DataRow("candycrush", false, 2, "list_pi", false)]
        [DataRow("candycrush", true, 1, "", false)]
        [DataRow("candycrush", false, 1, "", false)]
        [DataTestMethod]
        public async Task GetAddressDescriptions_EnableAddressValidationOnFocusOut_UsePaymentRequestApi(string partner, bool enableFeature, int pidlCount, string scenario, bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=address&operation=Add&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse;
            if (enableFeature)
            {
                expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enablePaymentRequestAddressValidation\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            }
            else
            {
                expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":\"inline\",\"resources\":null,\"features\":{\"enableSavePaymentDetails\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"enableExpiryCVVGrouping\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            }

            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (computeTax)
            {
                flights += ",PXEnableUsePOCapabilities";
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"test@example.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"OrderId\":\"test123\",\"OrderDate\":\"January 18 2023\"},\"lineItems\":[{\"imageUri\":\"https://example.com/image.png\",\"description\":\"Sample Item\",\"itemName\":\"Test Item\",\"chargeAmount\":150.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"Test Publisher\",\"productCode\":\"P001\",\"contentType\":\"Digital\"}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]}],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"test@example.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"OrderId\":\"test123\",\"OrderDate\":\"January 18 2023\"},\"lineItems\":[{\"imageUri\":\"https://example.com/image.png\",\"description\":\"Sample Item\",\"itemName\":\"Test Item\",\"chargeAmount\":150.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"Test Publisher\",\"productCode\":\"P001\",\"contentType\":\"Digital\"}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidls should not be null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            TestBase.ValidateAddressDescriptions(pidls);

            // Verify tax-related display hints
            pidls.ForEach(pidl =>
            {
                var cartTaxDisplayHint = pidl.GetDisplayHintById("cartTax") as PropertyDisplayHint;
                var cartTotalDisplayHint = pidl.GetDisplayHintById("cartTotal") as PropertyDisplayHint;
                var cartSubTotalDisplayHint = pidl.GetDisplayHintById("cartSubtotal") as PropertyDisplayHint;

                Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax is true");
                Assert.AreEqual(cartSubTotalDisplayHint != null, computeTax, "cartSubTotalDisplayHint should not be null if computeTax is true");
            });

            pidls.ForEach(pidl =>
            {
                // Test address fields for onFocusOut event and check for nextAction
                AddressDescription.AddressDataDescriptions.ToList().ForEach(dataDescriptionId =>
                {
                    if (pidl.DataDescription.ContainsKey(dataDescriptionId))
                    {
                        var addressDisplayHint = pidl.GetDisplayHintByPropertyName(dataDescriptionId) as PropertyDisplayHint;
                        Assert.IsNotNull(addressDisplayHint, "Address display hint should not be null");
                        Assert.IsNotNull(addressDisplayHint.Onfocusout, "OnFocusOut event should be present");

                        if (!computeTax)
                        {
                            // When computeTax is false, verify nextAction is present and is partnerActionWithPidlPayload type
                            Assert.IsNotNull(addressDisplayHint.Onfocusout.NextAction, "NextAction should be present when computeTax is false");
                            Assert.AreEqual(DisplayHintActionType.partnerActionWithPidlPayload.ToString(), addressDisplayHint.Onfocusout.NextAction.ActionType, "NextAction should be partnerActionWithPidlPayload when computeTax is false");

                            // Verify the href contains ModernValidate for address validation
                            if (enableFeature)
                            {
                                var eventContext = JsonConvert.DeserializeObject<EventContext>(
                                    JsonConvert.SerializeObject(addressDisplayHint.Onfocusout.Context));
                                Assert.IsTrue(eventContext.Href.Contains("ModernValidate"), "Href should contain ModernValidate when feature is enabled");
                                Assert.IsTrue(eventContext.Href.Contains("suggestAddressesTradeAVSUsePidlModal"), "Href should contain suggestAddressesTradeAVSUsePidlModal scenario");
                            }
                        }
                        else if (enableFeature)
                        {
                            // When feature is enabled and computeTax is true, verify nextAction is not present, and href contains suggestAddressesTradeAVSUsePidlModal
                            Assert.IsNull(addressDisplayHint.Onfocusout.NextAction, "NextAction should be present when feature is enabled");

                            // Check the href contains ModernValidate
                            var eventContext = JsonConvert.DeserializeObject<EventContext>(
                                JsonConvert.SerializeObject(addressDisplayHint.Onfocusout.Context));
                            Assert.IsTrue(eventContext.Href.Contains("ModernValidate"), "Href should contain ModernValidate");
                            Assert.IsTrue(eventContext.Href.Contains("suggestAddressesTradeAVSUsePidlModal"), "Href should contain suggestAddressesTradeAVSUsePidlModal scenario");
                        }
                        else
                        {
                            // When feature is disabled and computeTax is true, verify nextAction is not present
                            Assert.IsNull(addressDisplayHint.Onfocusout.NextAction, "NextAction should not be present when feature is disabled and computeTax is true");

                            // Verify the context contains CheckoutRequestsEx
                            var eventContext = JsonConvert.DeserializeObject<EventContext>(
                                JsonConvert.SerializeObject(addressDisplayHint.Onfocusout.Context));
                            Assert.IsTrue(eventContext.Href.Contains("CheckoutRequestsEx"), "Href should contain CheckoutRequestsEx");
                        }
                    }
                });
            });
        }

        [DataRow("candycrush", null, "checkout", 1, "success", true, "applepay", null, "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "applepay", null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "googlepay", null, "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "googlepay", null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "*", null, "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "*", null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 0, "success", true, null, null, "en-US")]
        [DataRow("candycrush", null, "checkout", 0, "success", true, null, null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "*", "PXUseMockWalletConfig", "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "applepay", "PXUseInlineExpressCheckoutHtml", "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "googlepay", "PXUseInlineExpressCheckoutHtml", "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "applepay", "PXUseInlineExpressCheckoutHtml,PXExpressCheckoutUseIntStaticResources", "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "googlepay", "PXUseInlineExpressCheckoutHtml,PXExpressCheckoutUseIntStaticResources", "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "applepay", "PXUseInlineExpressCheckoutHtml,PXExpressCheckoutUseProdStaticResources", "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "googlepay", "PXUseInlineExpressCheckoutHtml,PXExpressCheckoutUseProdStaticResources", "en-US")]
        [DataTestMethod]
        public async Task GetQuickPaymentDescriptions(string partner, string scenario, string expectedIdentity, int pidlCount, string expectedValidation, bool isPSD2, string paymentMethodType, string flightName, string language)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=quickPayment&operation=ExpressCheckout&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            string expectedAPPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"" + language + "\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            string expectedGPPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"" + language + "\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"" + language + "\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";

            if (paymentMethodType?.Equals("applepay", StringComparison.OrdinalIgnoreCase) ?? false)
            {
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedAPPOResponse);
            }
            else if (paymentMethodType?.Equals("googlepay", StringComparison.OrdinalIgnoreCase) ?? false)
            {
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedGPPOResponse);
            }
            else if (paymentMethodType?.Equals("*", StringComparison.OrdinalIgnoreCase) ?? false)
            {
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            if (flightName != null)
            {
                flights = string.Format("{0},{1}", flights, flightName);
            }

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, paymentMethodType == null ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            if (pidlCount > 0)
            {
                Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL idenity not expected");
                ValidateQuickPaymentDescription(pidls, expectedValidation, isPSD2, paymentMethodType, language);
            }
        }

        [DataRow("candycrush", null, "checkout", 1, "success", true, "applepay", null, "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "applepay", null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "googlepay", null, "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "googlepay", null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "*", null, "en-US")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "*", null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 0, "success", true, null, null, "en-US")]
        [DataRow("candycrush", null, "checkout", 0, "success", true, null, null, "it-IT")]
        [DataRow("candycrush", null, "checkout", 1, "success", true, "*", "PXUseMockWalletConfig", "en-US")]
        [DataTestMethod]
        public async Task GetQuickPaymentDescriptions_UsePaymentRequestApi(string partner, string scenario, string expectedIdentity, int pidlCount, string expectedValidation, bool isPSD2, string paymentMethodType, string flightName, string language)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=quickPayment&operation=ExpressCheckout&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            string expectedAPPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"" + language + "\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            string expectedGPPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"" + language + "\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"" + language + "\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";

            if (paymentMethodType?.Equals("applepay", StringComparison.OrdinalIgnoreCase) ?? false)
            {
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedAPPOResponse);
            }
            else if (paymentMethodType?.Equals("googlepay", StringComparison.OrdinalIgnoreCase) ?? false)
            {
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedGPPOResponse);
            }
            else if (paymentMethodType?.Equals("*", StringComparison.OrdinalIgnoreCase) ?? false)
            {
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            if (flightName != null)
            {
                flights = string.Format("{0},{1}", flights, flightName);
            }

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, paymentMethodType == null ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            if (pidlCount > 0)
            {
                Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL idenity not expected");
                ValidateQuickPaymentDescription(pidls, expectedValidation, isPSD2, paymentMethodType, language);
            }
        }

        [DataRow("candycrush", null, 1, "applepay", "expectedAPPOResponseIsTaxInclusiveFalseONAllLineItems")]
        [DataRow("candycrush", null, 1, "applepay", "expectedAPPOResponseIsTaxInclusiveFalseONOneLineItem")]
        [DataRow("candycrush", null, 1, "applepay", "expectedAPPOResponseIsTaxInclusiveTrueONAllLineItems")]
        [DataRow("candycrush", null, 1, "googlepay", "expectedGPPOResponseIsTaxInclusiveFalseONAllLineItems")]
        [DataRow("candycrush", null, 1, "googlepay", "expectedGPPOResponseIsTaxInclusiveFalseONOneLineItem")]
        [DataRow("candycrush", null, 1, "googlepay", "expectedGPPOResponseIsTaxInclusiveTrueONAllLineItems")]
        [DataTestMethod]
        public async Task GetQuickPaymentDescriptions_isTaxInclusive(string partner, string scenario, int pidlCount, string paymentMethodType, string response)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=quickPayment&operation=ExpressCheckout&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var expectedResponses = new Dictionary<string, string>();
            expectedResponses["expectedAPPOResponseIsTaxInclusiveFalseONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedAPPOResponseIsTaxInclusiveFalseONOneLineItem"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedAPPOResponseIsTaxInclusiveTrueONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedGPPOResponseIsTaxInclusiveFalseONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedGPPOResponseIsTaxInclusiveFalseONOneLineItem"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedGPPOResponseIsTaxInclusiveTrueONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";

            string expectedResponse = expectedResponses[response];
            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, paymentMethodType == null ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            if (pidlCount > 0)
            {
                var dataSource = pidls[0].DataSources["walletConfig"];
                var walletConfig = JsonConvert.DeserializeObject<WalletConfig>(JsonConvert.SerializeObject(dataSource.Members.FirstOrDefault()));
                Assert.IsNotNull(walletConfig, "WalletConfig should not be null for quick payment");
                Assert.IsNotNull(walletConfig.PIDLConfig, "PIDLConfig should not be null for quick payment");

                if (response.Equals("expectedAPPOResponseIsTaxInclusiveFalseONAllLineItems", StringComparison.OrdinalIgnoreCase)
                    || response.Equals("expectedAPPOResponseIsTaxInclusiveFalseONOneLineItem", StringComparison.OrdinalIgnoreCase)
                    || response.Equals("expectedGPPOResponseIsTaxInclusiveFalseONOneLineItem", StringComparison.OrdinalIgnoreCase)
                    || response.Equals("expectedGPPOResponseIsTaxInclusiveFalseONAllLineItems", StringComparison.OrdinalIgnoreCase))
                {
                    Assert.AreEqual("amount due plus applicable taxes", walletConfig.PaymentInstrumentHandlers[0].PayLabel, "Googlepay handler Paylabel should be amount due plus applicable taxes");
                    Assert.AreEqual("amount due plus applicable taxes", walletConfig.PaymentInstrumentHandlers[1].PayLabel, "Applepay handler Paylabel should be amount due plus applicable taxes");
                }
                else
                {
                    Assert.AreEqual("amount due", walletConfig.PaymentInstrumentHandlers[0].PayLabel, "Googlepay handler Paylabel should be amount due");
                    Assert.AreEqual("amount due", walletConfig.PaymentInstrumentHandlers[1].PayLabel, "Applepay handler Paylabel should be amount due");
                }
            }
        }

        [DataRow("candycrush", null, 1, "applepay", "expectedAPPOResponseIsTaxInclusiveFalseONAllLineItems")]
        [DataRow("candycrush", null, 1, "applepay", "expectedAPPOResponseIsTaxInclusiveFalseONOneLineItem")]
        [DataRow("candycrush", null, 1, "applepay", "expectedAPPOResponseIsTaxInclusiveTrueONAllLineItems")]
        [DataRow("candycrush", null, 1, "googlepay", "expectedGPPOResponseIsTaxInclusiveFalseONAllLineItems")]
        [DataRow("candycrush", null, 1, "googlepay", "expectedGPPOResponseIsTaxInclusiveFalseONOneLineItem")]
        [DataRow("candycrush", null, 1, "googlepay", "expectedGPPOResponseIsTaxInclusiveTrueONAllLineItems")]
        [DataTestMethod]
        public async Task GetQuickPaymentDescriptions_isTaxInclusive_UsePaymentRequestApi(string partner, string scenario, int pidlCount, string paymentMethodType, string response)
        {
            // Arrange
            int arrayIndexValue = string.Equals(paymentMethodType, "applepay") ? 0 : 1;
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=quickPayment&operation=ExpressCheckout&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var expectedResponses = new Dictionary<string, string>();
            expectedResponses["expectedAPPOResponseIsTaxInclusiveFalseONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedAPPOResponseIsTaxInclusiveFalseONOneLineItem"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedAPPOResponseIsTaxInclusiveTrueONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"applepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"ApplePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_applepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedGPPOResponseIsTaxInclusiveFalseONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedGPPOResponseIsTaxInclusiveFalseONOneLineItem"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
            expectedResponses["expectedGPPOResponseIsTaxInclusiveTrueONAllLineItems"] = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]},{\"paymentMethodType\":\"googlepay\",\"paymentMethodFamily\":\"ewallet\",\"display\":{\"name\":\"GooglePay\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\",\"logos\":[{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_googlepay.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":false,\"chargeThresholds\":[],\"redirectRequired\":[],\"soldToAddressRequired\":true,\"splitPaymentSupported\":true,\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"nonStoredPaymentMethodId\":null,\"isNonStoredPaymentMethod\":false},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-US\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":true,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";

            string expectedResponse = expectedResponses[response];
            PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedResponse);

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, paymentMethodType == null ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            if (pidlCount > 0)
            {
                var dataSource = pidls[0].DataSources["walletConfig"];
                var walletConfig = JsonConvert.DeserializeObject<WalletConfig>(JsonConvert.SerializeObject(dataSource.Members.FirstOrDefault()));
                Assert.IsNotNull(walletConfig, "WalletConfig should not be null for quick payment");
                Assert.IsNotNull(walletConfig.PIDLConfig, "PIDLConfig should not be null for quick payment");
                Assert.IsNotNull(walletConfig.PaymentInstrumentHandlers[arrayIndexValue].DisableGeoFencing);
                Assert.IsFalse(walletConfig.PaymentInstrumentHandlers[arrayIndexValue].DisableGeoFencing, "DisableGeoFencing should be false for express checkout");
                Assert.IsNotNull(walletConfig.PaymentInstrumentHandlers[arrayIndexValue].SingleMarkets);
                Assert.IsTrue(walletConfig.PaymentInstrumentHandlers[arrayIndexValue].SingleMarkets.Count > 0, "Single Markets should not be empty for express checkout");

                if (response.Equals("expectedAPPOResponseIsTaxInclusiveFalseONAllLineItems", StringComparison.OrdinalIgnoreCase)
                    || response.Equals("expectedAPPOResponseIsTaxInclusiveFalseONOneLineItem", StringComparison.OrdinalIgnoreCase)
                    || response.Equals("expectedGPPOResponseIsTaxInclusiveFalseONOneLineItem", StringComparison.OrdinalIgnoreCase)
                    || response.Equals("expectedGPPOResponseIsTaxInclusiveFalseONAllLineItems", StringComparison.OrdinalIgnoreCase))
                {
                    Assert.AreEqual("amount due plus applicable taxes", walletConfig.PaymentInstrumentHandlers[0].PayLabel, "Googlepay handler Paylabel should be amount due plus applicable taxes");
                    Assert.AreEqual("amount due plus applicable taxes", walletConfig.PaymentInstrumentHandlers[1].PayLabel, "Applepay handler Paylabel should be amount due plus applicable taxes");
                }
                else
                {
                    Assert.AreEqual("amount due", walletConfig.PaymentInstrumentHandlers[0].PayLabel, "Googlepay handler Paylabel should be amount due");
                    Assert.AreEqual("amount due", walletConfig.PaymentInstrumentHandlers[1].PayLabel, "Applepay handler Paylabel should be amount due");
                }
            }
        }

        [DataRow("candycrush", null, "paymentMethod", 4, "credit_card_visa_amex_mc_discover")]
        [DataRow("candycrush", "list_pi", "paymentMethod", 2, "list_pi")]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_Select(string partner, string scenario, string expectedIdentity, int paramsCount, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=select&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL idenity not expected");
            ValidatePaymentDescriptions_Select(pidls, paramsCount, expectedValidation);
        }

        [DataRow("candycrush", null, "paymentMethod", 4, "credit_card_visa_amex_mc_discover")]
        [DataRow("candycrush", "list_pi", "paymentMethod", 2, "list_pi")]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_Select_UsePaymentRequestApi(string partner, string scenario, string expectedIdentity, int paramsCount, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=select&scenario={0}&partner={1}", scenario, partner);

            string expectedPSSResponse = "{\"select\":{\"template\":\"selectpmradiobuttonlist\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL idenity not expected");
            ValidatePaymentDescriptions_Select(pidls, paramsCount, expectedValidation);
        }

        [DataRow("candycrush", null, 0, null, true)]
        [DataRow("candycrush", "paymentinstrument", 1, "••••1344 10/50", true)]
        [DataRow("candycrush", "paymentinstrument", 1, "••••1344 10/50", false)]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_SelectInstance(string partner, string expectedIdentity, int pidlCount, string expectedValidation, bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=selectinstance&partner={0}", partner);

            string expectedPSSResponse = "{\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (pidlCount == 0)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else
            {
                if (computeTax)
                {
                    flights += ",PXEnableUsePOCapabilities";
                    string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                    PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
                }
                else
                {
                    string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                    PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
                }
            }

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            PaymentDescription paymentDescription = new PaymentDescription();
            paymentDescription.CheckoutRequestClientActions = new CheckoutRequestClientActions()
            {
                Capabilities = new PaymentCapabilities()
                {
                    ComputeTax = computeTax
                }
            };

            if (computeTax)
            {
                paymentDescription.ExposedFlightFeatures = new List<string> { "PXEnableUsePOCapabilities" };
            }

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, pidlCount == 0 ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            bool cartTaxDataDescriptionExist = false;
            bool cartTotalDataDescriptionExist = false;

            if (pidlCount > 0)
            {
                var selectOption = pidls[0].GetDisplayHintById("paymentInstrument") as PropertyDisplayHint;
                var possibleOptions = selectOption?.PossibleOptions?.FirstOrDefault().Value;
                Assert.AreEqual(expectedValidation, possibleOptions?.DisplayText, "Display text should be matched");
                Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL idenity not expected");

                Assert.IsNotNull(possibleOptions.OnResourceSelected, "Select instance OnResourceSelected should not be null");
                Assert.AreEqual(possibleOptions.OnResourceSelected?.EventType, "mergeData", "Select instance OnResourceSelected event type should be mergeData");

                var eventContext = JsonConvert.DeserializeObject<EventContext>(JsonConvert.SerializeObject(possibleOptions.OnResourceSelected.Context));
                Assert.IsNotNull(eventContext, "Select instance OnResourceSelected context should not be null");
                Assert.IsTrue(eventContext.Explicit, "Select instance OnResourceSelected event context explicit should be true");
                Assert.IsNotNull(eventContext.Payload, "Select instance OnResourceSelected payload should not be null");
                var cartTaxDisplayHint = pidls[0].GetDisplayHintById("cart_tax") as PropertyDisplayHint;
                var cartTotalDisplayHint = pidls[0].GetDisplayHintById("cart_total") as PropertyDisplayHint;

                Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is false");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax false");

                pidls.ForEach(pidl =>
                {
                    var submitGroup = pidl.GetDisplayHintById("cancelSaveGroup") as GroupDisplayHint;
                    Assert.IsNotNull(submitGroup, "Select instance PIDL submit group should not be null");
                    Assert.IsTrue(submitGroup.IsSumbitGroup, "Select instance should have the submit group");

                    var saveButton = pidl.GetDisplayHintById("saveButton") as ButtonDisplayHint;
                    Assert.IsNotNull(saveButton, "Select instance save button should not be null");
                    Assert.AreEqual(saveButton.Action?.ActionType, "success", "Select instance save button action type should be success");
                    Assert.IsTrue(saveButton.IsHidden, "Select instance save button should be hidden");

                    paymentDescription.SelectInstanceDataDescriptions.ToList().ForEach(dataDescriptions =>
                    {
                        if (pidl.DataDescription.ContainsKey(dataDescriptions))
                        {
                            cartTaxDataDescriptionExist = dataDescriptions.Equals("cart_tax", StringComparison.OrdinalIgnoreCase) || cartTaxDataDescriptionExist;
                            cartTotalDataDescriptionExist = dataDescriptions.Equals("cart_total", StringComparison.OrdinalIgnoreCase) || cartTotalDataDescriptionExist;
                            Assert.IsTrue(eventContext.Payload.ContainsKey(dataDescriptions), "Select instance OnResourceSelected payload should contains the data description");

                            var addresssProperty = pidl.DataDescription[dataDescriptions] as PropertyDescription;

                            if (ComponentDescription.ShouldEnableEmitEventOnPropertyUpdate(dataDescriptions))
                            {
                                Assert.IsTrue(addresssProperty.EmitEventOnPropertyUpdate);
                            }

                            Assert.IsNotNull(addresssProperty, "Select instance property description should not be null");
                            Assert.AreEqual(addresssProperty.BroadcastTo, dataDescriptions, "Broadcast to property should be matching with property name of the address/OrderSummary PIDL");

                            var addressDisplayHint = pidl.GetDisplayHintByPropertyName(dataDescriptions) as PropertyDisplayHint;
                            Assert.IsNotNull(addressDisplayHint, "Select instance display hint should not be null");
                            Assert.IsTrue(addressDisplayHint.IsHidden, "Select instance address and order summary property should be hidden");
                        }
                    });
                });

                Assert.AreEqual(cartTaxDataDescriptionExist, computeTax, "cartTax data decription should not be null if computeTax is false");
                Assert.AreEqual(cartTotalDataDescriptionExist, computeTax, "cartTotal data description should not be null if computeTax false");
            }
        }

        [DataRow("candycrush", null, 0, null, true)]
        [DataRow("candycrush", "paymentinstrument", 1, "••••1344 10/50", true)]
        [DataRow("candycrush", "paymentinstrument", 1, "••••1344 10/50", false)]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_SelectInstance_UsePaymentRequestApi(string partner, string expectedIdentity, int pidlCount, string expectedValidation, bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=selectinstance&partner={0}", partner);

            string expectedPSSResponse = "{\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (pidlCount == 0)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }
            else
            {
                if (computeTax)
                {
                    flights += ",PXEnableUsePOCapabilities";
                    string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                    PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
                }
                else
                {
                    string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                    PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
                }
            }

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            PaymentDescription paymentDescription = new PaymentDescription();
            paymentDescription.CheckoutRequestClientActions = new CheckoutRequestClientActions()
            {
                Capabilities = new PaymentCapabilities()
                {
                    ComputeTax = computeTax
                }
            };

            if (computeTax)
            {
                paymentDescription.ExposedFlightFeatures = new List<string> { "PXEnableUsePOCapabilities" };
            }

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, pidlCount == 0 ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");
            bool cartTaxDataDescriptionExist = false;
            bool cartTotalDataDescriptionExist = false;

            if (pidlCount > 0)
            {
                var selectOption = pidls[0].GetDisplayHintById("paymentInstrument") as PropertyDisplayHint;
                var possibleOptions = selectOption?.PossibleOptions?.FirstOrDefault().Value;
                Assert.AreEqual(expectedValidation, possibleOptions?.DisplayText, "Display text should be matched");
                Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL idenity not expected");

                Assert.IsNotNull(possibleOptions.OnResourceSelected, "Select instance OnResourceSelected should not be null");
                Assert.AreEqual(possibleOptions.OnResourceSelected?.EventType, "mergeData", "Select instance OnResourceSelected event type should be mergeData");

                var eventContext = JsonConvert.DeserializeObject<EventContext>(JsonConvert.SerializeObject(possibleOptions.OnResourceSelected.Context));
                Assert.IsNotNull(eventContext, "Select instance OnResourceSelected context should not be null");
                Assert.IsTrue(eventContext.Explicit, "Select instance OnResourceSelected event context explicit should be true");
                Assert.IsNotNull(eventContext.Payload, "Select instance OnResourceSelected payload should not be null");
                var cartTaxDisplayHint = pidls[0].GetDisplayHintById("cart_tax") as PropertyDisplayHint;
                var cartTotalDisplayHint = pidls[0].GetDisplayHintById("cart_total") as PropertyDisplayHint;

                Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is false");
                Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax false");

                pidls.ForEach(pidl =>
                {
                    var submitGroup = pidl.GetDisplayHintById("cancelSaveGroup") as GroupDisplayHint;
                    Assert.IsNotNull(submitGroup, "Select instance PIDL submit group should not be null");
                    Assert.IsTrue(submitGroup.IsSumbitGroup, "Select instance should have the submit group");

                    var saveButton = pidl.GetDisplayHintById("saveButton") as ButtonDisplayHint;
                    Assert.IsNotNull(saveButton, "Select instance save button should not be null");
                    Assert.AreEqual(saveButton.Action?.ActionType, "success", "Select instance save button action type should be success");
                    Assert.IsTrue(saveButton.IsHidden, "Select instance save button should be hidden");

                    paymentDescription.SelectInstanceDataDescriptions.ToList().ForEach(dataDescriptions =>
                    {
                        if (pidl.DataDescription.ContainsKey(dataDescriptions))
                        {
                            cartTaxDataDescriptionExist = dataDescriptions.Equals("cart_tax", StringComparison.OrdinalIgnoreCase) || cartTaxDataDescriptionExist;
                            cartTotalDataDescriptionExist = dataDescriptions.Equals("cart_total", StringComparison.OrdinalIgnoreCase) || cartTotalDataDescriptionExist;
                            Assert.IsTrue(eventContext.Payload.ContainsKey(dataDescriptions), "Select instance OnResourceSelected payload should contains the data description");

                            var addresssProperty = pidl.DataDescription[dataDescriptions] as PropertyDescription;

                            if (ComponentDescription.ShouldEnableEmitEventOnPropertyUpdate(dataDescriptions))
                            {
                                Assert.IsTrue(addresssProperty.EmitEventOnPropertyUpdate);
                            }

                            Assert.IsNotNull(addresssProperty, "Select instance property description should not be null");
                            Assert.AreEqual(addresssProperty.BroadcastTo, dataDescriptions, "Broadcast to property should be matching with property name of the address/OrderSummary PIDL");

                            var addressDisplayHint = pidl.GetDisplayHintByPropertyName(dataDescriptions) as PropertyDisplayHint;
                            Assert.IsNotNull(addressDisplayHint, "Select instance display hint should not be null");
                            Assert.IsTrue(addressDisplayHint.IsHidden, "Select instance address and order summary property should be hidden");
                        }
                    });
                });

                Assert.AreEqual(cartTaxDataDescriptionExist, computeTax, "cartTax data decription should not be null if computeTax is false");
                Assert.AreEqual(cartTotalDataDescriptionExist, computeTax, "cartTotal data description should not be null if computeTax false");
            }
        }

        /// <summary>
        /// This CIT validates the CVV and its properties based on various parameters.
        /// </summary>
        /// <param name="enableChallengeCvvValidationStatus">Indicates whether the flight for enabling CVV validation is active.</param>
        /// <param name="isUrlContainsPartnerName">Specifies if the URL includes the partner name.</param>
        /// <param name="isPSSSettingRequire">Determines if the PSS setting is required. Note: PSS settings can only be applied when the URL contains the partner name. If the partner name is absent, it defaults to 'default', resulting in null settings.</param>
        /// <returns></returns>
        [DataRow(true, false, false)]
        [DataRow(false, true, false)]
        [DataRow(true, true, true)]
        [DataRow(false, false, true)]
        [DataRow(false, false, true, true)]
        [TestMethod]
        public async Task GetPaymentRequestConfirmDescriptionChallengePidlTest(bool enableChallengeCvvValidationStatus, bool enableSecureField, bool isUrlContainsPartnerName, bool isPSSSettingRequire = false)
        {
            // Arrange
            string piid = "Account001-Pi001-Visa";
            string requestId = "pr_39c93cc0-e855-42bc-8aca-183a572e14bc";
            string url = isUrlContainsPartnerName ? "/v7.0/PaymentClient/descriptions?partner=battlenet&operation=Add&component=confirm" : "/v7.0/PaymentClient/descriptions?operation=Add&component=confirm";
            Dictionary<string, string> headers = new Dictionary<string, string>();

            string requestContext = "{\"tenantId\":\"tn_3f1b8c1e2c3e4c5f8b6e7d8e9f0a1b2c\",\"tenantCustomerId\":\"abc\",\"requestId\":\"pr_39c93cc0-e855-42bc-8aca-183a572e14bc\",\"paymentAccountId\":\"123\"}";

            var paymentRequestClientActions = new PaymentRequestClientActions
            {
                PaymentRequestId = requestId,
                Status = PaymentRequestStatus.PendingClientAction,
                Country = "US",
                Currency = "USD",
                Amount = 100,
                PaymentInstruments = new List<PaymentInstrument>(),
                ClientActions = new List<PaymentRequestClientAction>
                {
                    new PaymentRequestClientAction
                    {
                        Type = Microsoft.Commerce.Payments.PXService.Model.PaymentOrchestratorService.ClientActionType.HandleChallenge,
                        ChallengeType = PaymentInstrumentChallengeType.Cvv,
                        PaymentInstrument = new PaymentInstrument
                        {
                            PaymentInstrumentId = piid,
                            Usage = PaymentInstrumentUsage.PrimaryPaymentInstrument,
                            PaymentMethodType = Microsoft.Commerce.Payments.PXService.Model.PaymentOrchestratorService.PaymentMethodType.Visa
                        }
                    }
                }
            };

            PXSettings.PaymentOrchestratorService.ArrangeResponse(JsonConvert.SerializeObject(paymentRequestClientActions));

            headers.Add("x-ms-request-context", requestContext);

            string flightValue = string.Empty;

            if (enableChallengeCvvValidationStatus && !isUrlContainsPartnerName)
            {
                flightValue = "PXEnableChallengeCvvValidation";
            }

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"PXEnableChallengeCvvValidation\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":" + isPSSSettingRequire.ToString().ToLower() + "}]}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            if (isUrlContainsPartnerName)
            {
                flightValue = enableChallengeCvvValidationStatus ? "PXEnableChallengeCvvValidation" : string.Empty;
            }

            if (enableSecureField)
            {
                flightValue += flightValue != null ? "PXEnableSecureFieldCvvChallenge" : ",PXEnableSecureFieldCvvChallenge";
            }

            headers.Add("x-ms-flight", flightValue);

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(url, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidls should not be null");
            Assert.IsNotNull(pidls[0].DisplayPages, "DisplayPages should not be null for the first PIDL");
            Assert.AreEqual(1, pidls.Count, "Pidls count is not matching with the expected one");
            Assert.IsNull(pidls[0].GetDisplayHintById("challengecvvHeading"), "challengecvvHeading should be null");

            string cvvHintId = enableChallengeCvvValidationStatus || isPSSSettingRequire
                            ? "challengecvvSecurityCodeWithValidation"
                            : "challengecvvSecurityCode";

            var cvv = pidls[0].GetDisplayHintById(cvvHintId) as DisplayHint;

            Assert.IsNotNull(cvv, $"{cvvHintId} display hint should not be null");

            var buttonHintId = pidls[0].GetDisplayHintById("nextButton") as ButtonDisplayHint;
            Assert.IsNotNull(buttonHintId, $"{buttonHintId} display hint should not be null");
            Assert.IsNotNull(buttonHintId.DisplayHintType, "displayHint Type should not be null");
            Assert.IsNotNull(buttonHintId.Action);
            Assert.AreEqual(buttonHintId.Action?.ActionType, "submit", $"The button should have submit as displayHintType");
            Assert.IsNotNull(buttonHintId.Action.Context, "The context should not be null");

            if (enableSecureField)
            {
                Assert.IsTrue(cvv is SecurePropertyDisplayHint, "cvv display hint should be secure field element");
                ValidateSecurePropertyDisplayHint(cvv as SecurePropertyDisplayHint, enableChallengeCvvValidationStatus, isPSSSettingRequire);
            }
            else
            {
                Assert.IsTrue(cvv is PropertyDisplayHint, "cvv display hint should be regular property element");
                ValidatePropertyDisplayHint(cvv as PropertyDisplayHint, enableChallengeCvvValidationStatus, isPSSSettingRequire);
            }
        }

        [TestMethod]
        public async Task GetPaymentRequestConfirmDescriptionClientActionTest()
        {
            // Arrange
            ////string piid = "Account001-Pi001-Visa";
            string requestId = "pr_39c93cc0-e855-42bc-8aca-183a572e14bc";
            string url = "/v7.0/PaymentClient/descriptions?operation=Add&component=confirm";

            string requestContext = "{\"tenantId\":\"tn_3f1b8c1e2c3e4c5f8b6e7d8e9f0a1b2c\",\"tenantCustomerId\":\"abc\",\"requestId\":\"pr_39c93cc0-e855-42bc-8aca-183a572e14bc\",\"paymentAccountId\":\"123\"}";

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"PXEnableChallengeCvvValidation\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var paymentRequestClientActions = new PaymentRequestClientActions
            {
                PaymentRequestId = requestId,
                Status = PaymentRequestStatus.PendingInitialTransaction,
                Country = "US",
                Currency = "USD",
                Amount = 100,
                PaymentInstruments = new List<PaymentInstrument>(),
                ClientActions = new List<PaymentRequestClientAction>()
            };

            PXSettings.PaymentOrchestratorService.ArrangeResponse(JsonConvert.SerializeObject(paymentRequestClientActions));

            HttpRequestMessage request = new HttpRequestMessage()
            {
                RequestUri = new Uri(GetPXServiceUrl(url)),
                Method = HttpMethod.Get
            };

            request.Headers.Add("x-ms-request-context", requestContext);

            // Act
            var response = await PXClient.SendAsync(request);

            // Assert
            Assert.AreEqual(HttpStatusCode.OK, response.StatusCode, "The HttpStatusCode is expected to be OK");

            string result = await response.Content.ReadAsStringAsync();
            var pidls = JsonConvert.DeserializeObject<List<PIDLResource>>(result);

            Assert.AreEqual(1, pidls.Count, "Pidls count is not matching with the expected one");
            Assert.IsNotNull(pidls[0].ClientAction, "ClientAction is expected to be not null");
            Assert.IsNotNull(pidls[0].ClientAction.Context, "ClientAction.Context is expected to be not null");
        }

        [DataRow(true, "2")]
        [DataRow(true, "")]
        [DataRow(false, "")]
        [DataRow(false, "2")]
        [TestMethod]
        public async Task GetPaymentRequestConfirmDescription3DS2ChallengeTest(bool isChallengeWindowSize = false, string challengeWindowSize = "")
        {
            // Arrange
            string piid = "Account001-Pi001-Visa";
            string requestId = "pr_39c93cc0-e855-42bc-8aca-183a572e14bc";
            string url = "/v7.0/PaymentClient/descriptions?operation=Add&component=confirm";

            if (isChallengeWindowSize)
            {
                url += $"&challengeWindowSize=1";
            }

            string requestContext = "{\"tenantId\":\"tn_3f1b8c1e2c3e4c5f8b6e7d8e9f0a1b2c\",\"tenantCustomerId\":\"abc\",\"requestId\":\"pr_39c93cc0-e855-42bc-8aca-183a572e14bc\",\"paymentAccountId\":\"123\"}";

            string expectedPSSResponse = "{\"add\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"challengeWindowSize\":\" " + challengeWindowSize.ToLower().ToString() + "\",\"features\":{\"PXEnableChallengeCvvValidation\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":[{\"usePSSForPXFeatureFlighting\":true}]}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var paymentRequestClientActions = new PaymentRequestClientActions
            {
                PaymentRequestId = requestId,
                Status = PaymentRequestStatus.PendingClientAction,
                Country = "US",
                Currency = "USD",
                Amount = 100,
                PaymentInstruments = new List<PaymentInstrument>(),
                ClientActions = new List<PaymentRequestClientAction>
                {
                    new PaymentRequestClientAction
                    {
                        Type = Microsoft.Commerce.Payments.PXService.Model.PaymentOrchestratorService.ClientActionType.HandleChallenge,
                        ChallengeType = PaymentInstrumentChallengeType.ThreeDs2,
                        PaymentInstrument = new PaymentInstrument
                        {
                            PaymentInstrumentId = piid,
                            Usage = PaymentInstrumentUsage.PrimaryPaymentInstrument,
                            PaymentMethodType = Microsoft.Commerce.Payments.PXService.Model.PaymentOrchestratorService.PaymentMethodType.Visa
                        }
                    }
                }
            };

            PXSettings.PaymentOrchestratorService.ArrangeResponse(JsonConvert.SerializeObject(paymentRequestClientActions));

            PXSettings.PayerAuthService.ArrangeResponse(
               method: HttpMethod.Post,
               urlPattern: ".*/GetThreeDSMethodURL.*",
               statusCode: HttpStatusCode.OK,
               content: "{\"three_ds_server_trans_id\":\"7b41a540-cbf8-4ada-85f6-24d4705f983b\",\"three_ds_method_url\":\"https://payments-acs-emulator-fzeug0g7atchf8d7.b02.azurefd.net/acs/fingerprint\",\"tracking_id\":\"00000000-0000-0000-0000-000000000000\"}");

            HttpRequestMessage request = new HttpRequestMessage()
            {
                RequestUri = new Uri(GetPXServiceUrl(url)),
                Method = HttpMethod.Get
            };

            request.Headers.Add("x-ms-request-context", requestContext);

            // Act
            var response = await PXClient.SendAsync(request);

            // Assert
            Assert.AreEqual(HttpStatusCode.OK, response.StatusCode);
            string result = await response.Content.ReadAsStringAsync();
            var pidls = JsonConvert.DeserializeObject<List<Microsoft.Commerce.Payments.PidlModel.V7.PIDLResource>>(result);
            Assert.AreEqual(1, pidls.Count, "Pidls count is expected to be one");
            Assert.IsNotNull(pidls[0].ClientAction, "Client action missing");
            Assert.AreEqual(global::Tests.Common.Model.Pidl.ClientActionType.Pidl.ToString(), pidls[0].ClientAction.ActionType.ToString());
            Assert.IsNotNull(pidls[0].ClientAction.Context, "Client action context missing");
        }

        private void ValidatePropertyDisplayHint(PropertyDisplayHint displayHint, bool enableChallengeCvvValidationStatus, bool isPSSSettingRequire)
        {
            if (enableChallengeCvvValidationStatus || isPSSSettingRequire)
            {
                Assert.IsNotNull(displayHint.DisplayErrorMessages, "DisplayErrorMessages should not be null for CVV");
                Assert.IsTrue(displayHint.DisplayErrorMessages.DefaultErrorMessage.Contains("Invalid card verification code"), "DefaultErrorMessage should contain 'Invalid card verification code'");
                Assert.AreEqual(displayHint.MinLength, 3, "CVV MinLength should be 3");
                Assert.AreEqual(displayHint.MaxLength, 4, "CVV MaxLength should be 4");
            }
            else
            {
                Assert.IsNull(displayHint.DisplayErrorMessages, "DisplayErrorMessages should be null for CVV");
                Assert.IsNull(displayHint.MinLength, "CVV MinLength should be null");
                Assert.IsNull(displayHint.MaxLength, "CVV MaxLength should be null");
            }
        }

        private void ValidateSecurePropertyDisplayHint(SecurePropertyDisplayHint displayHint, bool enableChallengeCvvValidationStatus, bool isPSSSettingRequire)
        {
            if (enableChallengeCvvValidationStatus || isPSSSettingRequire)
            {
                Assert.IsNotNull(displayHint.DisplayErrorMessages, "DisplayErrorMessages should not be null for CVV");
                Assert.IsTrue(displayHint.DisplayErrorMessages.DefaultErrorMessage.Contains("Invalid card verification code"), "DefaultErrorMessage should contain 'Invalid card verification code'");
                Assert.AreEqual(displayHint.MinLength, 3, "CVV MinLength should be 3");
                Assert.AreEqual(displayHint.MaxLength, 4, "CVV MaxLength should be 4");
            }
            else
            {
                Assert.IsNull(displayHint.DisplayErrorMessages, "DisplayErrorMessages should be null for CVV");
                Assert.IsNull(displayHint.MinLength, "CVV MinLength should be null");
                Assert.IsNull(displayHint.MaxLength, "CVV MaxLength should be null");
            }
        }

        [DataRow("candycrush", "paymentinstrument", "••••1344 04/50")]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_SelectInstance_DeletePI(string partner, string expectedIdentity, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=selectinstance&partner={0}", partner);

            string expectedPSSResponse = "{\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}, \"enableDeletePaymentInstrument\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");

            var selectOption = pidls[0].GetDisplayHintById("paymentInstrument") as PropertyDisplayHint;
            var possibleOptions = selectOption?.PossibleOptions?.FirstOrDefault().Value;
            Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

            var imageHint = possibleOptions.DisplayContent.Members[0] as ImageDisplayHint;
            Assert.IsNotNull(imageHint, "Logo display hint should not benull");

            var groupHint = possibleOptions.DisplayContent.Members[1] as GroupDisplayHint;
            Assert.IsNotNull(groupHint, "Text and button group hint should not be null");

            var textGroup = groupHint.Members[0] as TextGroupDisplayHint;
            Assert.IsNotNull(textGroup, "Text group display hint should not be null");

            var textHint = textGroup.Members[0] as TextDisplayHint;
            Assert.IsNotNull(textHint, "Display text hint should not be null");
            Assert.AreEqual(expectedValidation, textHint.DisplayContent, "Display text should be matched");

            var buttonHint = groupHint.Members[1] as ButtonDisplayHint;
            Assert.IsNotNull(buttonHint, "Button display hint should not be null");
            Assert.AreEqual(buttonHint.Action.ActionType, "success", "Delete button action type should be success");

            var actionContext = JsonConvert.DeserializeObject<ActionContext>(JsonConvert.SerializeObject(buttonHint.Action.Context));
            Assert.IsNotNull(actionContext, "Button action context should not be null");
            Assert.AreEqual(actionContext.ResourceActionContext.ResourceInfo.Id, selectOption?.PossibleOptions?.FirstOrDefault().Key, "Section option ID and delete button resource info id should match");
        }

        [DataRow("candycrush", "paymentinstrument", "••••1344 04/50")]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_SelectInstance_DeletePI_UsePaymentRequestApi(string partner, string expectedIdentity, string expectedValidation)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=selectinstance&partner={0}", partner);

            string expectedPSSResponse = "{\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}, \"enableDeletePaymentInstrument\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert - Will add more assert in next iteration
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");

            var selectOption = pidls[0].GetDisplayHintById("paymentInstrument") as PropertyDisplayHint;
            var possibleOptions = selectOption?.PossibleOptions?.FirstOrDefault().Value;
            Assert.AreEqual(expectedIdentity.ToLower(), pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

            var imageHint = possibleOptions.DisplayContent.Members[0] as ImageDisplayHint;
            Assert.IsNotNull(imageHint, "Logo display hint should not benull");

            var groupHint = possibleOptions.DisplayContent.Members[1] as GroupDisplayHint;
            Assert.IsNotNull(groupHint, "Text and button group hint should not be null");

            var textGroup = groupHint.Members[0] as TextGroupDisplayHint;
            Assert.IsNotNull(textGroup, "Text group display hint should not be null");

            var textHint = textGroup.Members[0] as TextDisplayHint;
            Assert.IsNotNull(textHint, "Display text hint should not be null");
            Assert.AreEqual(expectedValidation, textHint.DisplayContent, "Display text should be matched");

            var buttonHint = groupHint.Members[1] as ButtonDisplayHint;
            Assert.IsNotNull(buttonHint, "Button display hint should not be null");
            Assert.AreEqual(buttonHint.Action.ActionType, "success", "Delete button action type should be success");

            var actionContext = JsonConvert.DeserializeObject<ActionContext>(JsonConvert.SerializeObject(buttonHint.Action.Context));
            Assert.IsNotNull(actionContext, "Button action context should not be null");
            Assert.AreEqual(actionContext.ResourceActionContext.ResourceInfo.Id, selectOption?.PossibleOptions?.FirstOrDefault().Key, "Section option ID and delete button resource info id should match");
        }

        [TestMethod]
        [DataRow(true, DisplayName = "With ComputeTax Enabled")]
        [DataRow(false, DisplayName = "With ComputeTax Disabled")]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_SelectInstance_AddressValidationAndEmissionForPaaS(bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=selectinstance&partner={0}", "candycrush");

            // Create PSS response with enablePaymentRequestAddressValidation feature
            string expectedPSSResponse = "{\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"enablePaymentRequestAddressValidation\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":null}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            PaymentDescription paymentDescription = new PaymentDescription();
            paymentDescription.CheckoutRequestClientActions = new CheckoutRequestClientActions()
            {
                Capabilities = new PaymentCapabilities()
                {
                    ComputeTax = computeTax
                }
            };

            // Create PO response with payment instruments
            if (computeTax)
            {
                flights += ",PXEnableUsePOCapabilities";
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
                if (computeTax)
                {
                    paymentDescription.ExposedFlightFeatures = new List<string> { "PXEnableUsePOCapabilities" };
                }
            }
            else
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "cr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            Assert.AreEqual("paymentinstrument", pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

            // Get the payment instrument selection hint (dropdown)
            var selectOption = pidls[0].GetDisplayHintById("paymentInstrument") as PropertyDisplayHint;
            Assert.IsNotNull(selectOption, "Payment instrument selection hint should not be null");
            Assert.IsTrue(selectOption.PossibleOptions.Count > 0, "Payment instrument selection should have options");

            // Verify tax-related display hints
            var cartTaxDisplayHint = pidls[0].GetDisplayHintById("cart_tax") as PropertyDisplayHint;
            var cartTotalDisplayHint = pidls[0].GetDisplayHintById("cart_total") as PropertyDisplayHint;

            Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is true");
            Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax is true");

            bool cartTaxDataDescriptionExist = false;
            bool cartTotalDataDescriptionExist = false;

            paymentDescription.SelectInstanceDataDescriptions.ToList().ForEach(dataDescriptions =>
            {
                if (pidls[0].DataDescription.ContainsKey(dataDescriptions))
                {
                    cartTaxDataDescriptionExist = dataDescriptions.Equals("cart_tax", StringComparison.OrdinalIgnoreCase) || cartTaxDataDescriptionExist;
                    cartTotalDataDescriptionExist = dataDescriptions.Equals("cart_total", StringComparison.OrdinalIgnoreCase) || cartTotalDataDescriptionExist;
                }
            });

            Assert.AreEqual(cartTaxDataDescriptionExist, computeTax, "cartTax data description should not be null if computeTax is true");
            Assert.AreEqual(cartTotalDataDescriptionExist, computeTax, "cartTotal data description should not be null if computeTax is true");

            // Verify that all payment instrument options have the correct OnResourceSelected event setup
            foreach (var option in selectOption.PossibleOptions)
            {
                var optionValue = option.Value;
                Assert.IsNotNull(optionValue.OnResourceSelected, "OnResourceSelected should not be null");
                Assert.AreEqual("mergeData", optionValue.OnResourceSelected.EventType, "EventType should be mergeData");

                var eventContext = JsonConvert.DeserializeObject<EventContext>(JsonConvert.SerializeObject(optionValue.OnResourceSelected.Context));
                Assert.IsNotNull(eventContext, "Event context should not be null");
                Assert.IsTrue(eventContext.Explicit, "Event context explicit should be true");
                Assert.IsNotNull(eventContext.Payload, "Event payload should not be null");

                // Check that NextAction is present for address validation regardless of compute tax setting
                if (!computeTax)
                {
                    Assert.IsNotNull(optionValue.OnResourceSelected.NextAction, "NextAction should be present if computer tax is false");
                    Assert.AreEqual("partnerActionWithPidlPayload", optionValue.OnResourceSelected.NextAction.ActionType.ToString(), "NextAction should be partnerActionWithPidlPayload for address validation");
                }
                else
                {
                    Assert.IsNull(optionValue.OnResourceSelected.NextAction, "NextAction should be null when compute tax is true");
                }
            }
        }

        [TestMethod]
        [DataRow(true, DisplayName = "With ComputeTax Enabled")]
        [DataRow(false, DisplayName = "With ComputeTax Disabled")]
        [DataTestMethod]
        public async Task GetPaymentDescriptions_SelectInstance_AddressValidationAndEmissionForPaaS_UsePaymentRequestApi(bool computeTax)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";
            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?component=payment&operation=selectinstance&partner={0}", "candycrush");

            // Create PSS response with enablePaymentRequestAddressValidation feature
            string expectedPSSResponse = "{\"selectinstance\":{\"template\":\"listpidropdown\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"enablePaymentRequestAddressValidation\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null},\"chinaAllowVisaMasterCard\":{\"applicableMarkets\":[\"cn\"],\"displayCustomizationDetail\":null},\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}},\"default\":{\"template\":\"defaulttemplate\",\"redirectionPattern\":null,\"resources\":null,\"features\":{\"paymentClientHandlePaymentCollection\":{\"applicableMarkets\":[],\"displayCustomizationDetail\":null}}}}";
            PXSettings.PartnerSettingsService.ArrangeResponse(expectedPSSResponse);

            PaymentDescription paymentDescription = new PaymentDescription();
            paymentDescription.CheckoutRequestClientActions = new CheckoutRequestClientActions()
            {
                Capabilities = new PaymentCapabilities()
                {
                    ComputeTax = computeTax
                }
            };

            // Create PO response with payment instruments
            if (computeTax)
            {
                flights += ",PXEnableUsePOCapabilities";
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":true,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
                if (computeTax)
                {
                    paymentDescription.ExposedFlightFeatures = new List<string> { "PXEnableUsePOCapabilities" };
                }
            }
            else
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Visa\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_visa.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[129600]},\"exclusionTags\":[]},{\"paymentMethodType\":\"amex\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"American Express\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_amex.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080,10080]},\"exclusionTags\":[]},{\"paymentMethodType\":\"mc\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"MasterCard\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_mc.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[43200,43200,43200,43200,43200]},\"exclusionTags\":[]},{\"paymentMethodType\":\"discover\",\"paymentMethodFamily\":\"credit_card\",\"display\":{\"name\":\"Discover Network\",\"logo\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\",\"logos\":[{\"mimeType\":\"image/png\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover_rect.png\"},{\"mimeType\":\"image/svg+xml\",\"url\":\"https://pmservices.cp.microsoft-int.com/staticresourceservice/images/v4/logo_discover.svg\"}]},\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"moBillingIdentityUrl\":\"\",\"riskyPaymentMethod\":false,\"authWindow\":10080,\"fundsAvailabilityWindow\":0,\"multipleLineItemsSupported\":true,\"splitPaymentSupported\":true,\"purchaseWaitTime\":0,\"redirectRequired\":[],\"reAuthWindows\":[]},\"exclusionTags\":[]}],\"paymentInstruments\":[{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"check\",\"paymentMethodFamily\":\"offline_bank_transfer\",\"properties\":{\"offlineRecurring\":false,\"userManaged\":false,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"charge\",\"refund\"],\"taxable\":true,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":null,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":null},{\"id\":\"54caf9ba-184f-4d50-8728-14aa738c92ae\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":1,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"},{\"id\":\"54caf9ba-184f-4d50-8728-15738c93e\",\"accountId\":\"ac_3fecc26442b057e28286a771c7dcfdb9\",\"status\":2,\"paymentMethod\":{\"paymentMethodType\":\"visa\",\"paymentMethodFamily\":\"credit_card\",\"properties\":{\"offlineRecurring\":true,\"userManaged\":true,\"soldToAddressRequired\":true,\"chargeThresholds\":[],\"supportedOperations\":[\"authorize\",\"charge\",\"refund\",\"chargeback\"],\"taxable\":false,\"providerRemittable\":false,\"providerCountry\":null,\"moBillingIdentityUrl\":\"\",\"authWindow\":10080,\"reAuthWindows\":[]},\"exclusionTags\":[]},\"details\":{\"taxAmount\":15.45,\"accountHolderName\":\"PIMS Guest Checkout COT\",\"expiryYear\":2050,\"expiryMonth\":10,\"address\":{\"address_line1\":\"One Microsoft Way\",\"city\":\"Redmond\",\"region\":\"WA\",\"postal_code\":\"98052\",\"country\":\"US\"},\"lastFourDigits\":\"1344\",\"exportable\":false,\"cardType\":\"debit\",\"validationLevel\":\"full\",\"networkTokens\":[],\"isXboxCoBrandedCard\":false},\"creationDateTime\":\"2025-01-15T22:03:22.8091668Z\",\"lastUpdatedDateTime\":\"2025-01-16T00:00:17.66Z\"}],\"defaultPaymentInstrument\":{\"id\":\"21dd9edc-af71-4d62-80ce-37151d475326\"}},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":null,\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\",\"capabilities\":{\"computeTax\":false,\"sendEmail\":false,\"collectBillingAddress\":true}}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
            List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, HttpStatusCode.OK, additionaHeaders: headers);

            // Assert
            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(1, pidls.Count, "PIDL count not expected");
            Assert.AreEqual("paymentinstrument", pidls[0].Identity["description_type"].ToLower(), "PIDL identity not expected");

            // Get the payment instrument selection hint (dropdown)
            var selectOption = pidls[0].GetDisplayHintById("paymentInstrument") as PropertyDisplayHint;
            Assert.IsNotNull(selectOption, "Payment instrument selection hint should not be null");
            Assert.IsTrue(selectOption.PossibleOptions.Count > 0, "Payment instrument selection should have options");

            // Verify tax-related display hints
            var cartTaxDisplayHint = pidls[0].GetDisplayHintById("cart_tax") as PropertyDisplayHint;
            var cartTotalDisplayHint = pidls[0].GetDisplayHintById("cart_total") as PropertyDisplayHint;

            Assert.AreEqual(cartTaxDisplayHint != null, computeTax, "cartTaxDisplayHint should not be null if computeTax is true");
            Assert.AreEqual(cartTotalDisplayHint != null, computeTax, "cartTotalDisplayHint should not be null if computeTax is true");

            bool cartTaxDataDescriptionExist = false;
            bool cartTotalDataDescriptionExist = false;

            paymentDescription.SelectInstanceDataDescriptions.ToList().ForEach(dataDescriptions =>
            {
                if (pidls[0].DataDescription.ContainsKey(dataDescriptions))
                {
                    cartTaxDataDescriptionExist = dataDescriptions.Equals("cart_tax", StringComparison.OrdinalIgnoreCase) || cartTaxDataDescriptionExist;
                    cartTotalDataDescriptionExist = dataDescriptions.Equals("cart_total", StringComparison.OrdinalIgnoreCase) || cartTotalDataDescriptionExist;
                }
            });

            Assert.AreEqual(cartTaxDataDescriptionExist, computeTax, "cartTax data description should not be null if computeTax is true");
            Assert.AreEqual(cartTotalDataDescriptionExist, computeTax, "cartTotal data description should not be null if computeTax is true");

            // Verify that all payment instrument options have the correct OnResourceSelected event setup
            foreach (var option in selectOption.PossibleOptions)
            {
                var optionValue = option.Value;
                Assert.IsNotNull(optionValue.OnResourceSelected, "OnResourceSelected should not be null");
                Assert.AreEqual("mergeData", optionValue.OnResourceSelected.EventType, "EventType should be mergeData");

                var eventContext = JsonConvert.DeserializeObject<EventContext>(JsonConvert.SerializeObject(optionValue.OnResourceSelected.Context));
                Assert.IsNotNull(eventContext, "Event context should not be null");
                Assert.IsTrue(eventContext.Explicit, "Event context explicit should be true");
                Assert.IsNotNull(eventContext.Payload, "Event payload should not be null");

                // Check that NextAction is present for address validation regardless of compute tax setting
                if (!computeTax)
                {
                    Assert.IsNotNull(optionValue.OnResourceSelected.NextAction, "NextAction should be present if computer tax is false");
                    Assert.AreEqual("partnerActionWithPidlPayload", optionValue.OnResourceSelected.NextAction.ActionType.ToString(), "NextAction should be partnerActionWithPidlPayload for address validation");
                }
                else
                {
                    Assert.IsNull(optionValue.OnResourceSelected.NextAction, "NextAction should be null when compute tax is true");
                }
            }
        }

        [DataRow("candycrush", "payment", null, "Add", null, "visa", 0)]
        [DataRow("candycrush", "payment", null, "Add", "credit_card", null, 0)]
        [DataRow("candycrush", "payment", null, "Add", "credit_card", "visa", 1)]
        [DataRow("candycrush", "payment", null, "Add", "credit_card", "visa%2Camex%2Cmc%2Cdiscover", 4)]
        [DataTestMethod]
        public async Task GetPaymentClientDescriptions_AddCC_UsePaymentRequestApi(string partner, string component, string scenario, string operation, string family, string type, int pidlCount)
        {
            // Arrange
            var flights = "PXUsePartnerSettingsService,UsePaymentRequestApi";

            string requestUrl = string.Format("/v7.0/paymentClient/descriptions?type={0}&partner={1}&operation={2}&family={3}&component={4}", type, partner, operation, family, component);

            PXSettings.PartnerSettingsService.ArrangeResponse(Constants.PSSMockResponses.ExpectedPSSResponsePaymentClient);

            if (pidlCount == 0)
            {
                string expectedPOResponse = "{\"paymentMethodResults\":{\"paymentMethods\":[],\"paymentInstruments\":[],\"defaultPaymentInstrument\":null},\"profile\":{\"soldToAddress\":null,\"billingAddress\":null,\"addresses\":[],\"email\":\"aolivasaltam+2@microsoft.com\"},\"checkoutRequestId\":\"cr_5edd1d53-67e6-428e-ad8b-108c84af69c0\",\"paymentRequestId\":null,\"amount\":150.0,\"taxAmount\":0.0,\"subTotalAmount\":150.0,\"currency\":\"USD\",\"country\":\"US\",\"language\":\"en-us\",\"partnerName\":\"defaulttemplate\",\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658141Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658141Z\",\"OrderId\":\"ecc0bd0a37a14490bff84d5612a1bfcb\",\"OrderDate\":\"January 18 2025\"},\"lineItems\":[{\"imageUri\":\"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/cb/6b/60/cb6b606e-70c4-e5ca-742c-5b9c30a777f2/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1024x1024bb.png\",\"description\":\"Sample Item 1\",\"itemName\":\"Beginner's Bundle\",\"chargeAmount\":100.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":1,\"publisherName\":\"King store\",\"productCode\":\"P001\",\"contentType\":\"Digital\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.065825Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.065825Z\"}},{\"imageUri\":null,\"description\":\"Sample Item 2\",\"itemName\":\"Super Sweet Deal!\",\"chargeAmount\":50.0,\"tax\":0.0,\"isTaxInclusive\":false,\"quantity\":2,\"publisherName\":\"Publisher2\",\"productCode\":\"P002\",\"contentType\":\"Physical\",\"shipToAddress\":{\"country\":null,\"region\":null,\"district\":null,\"city\":null,\"addressLine1\":null,\"addressLine2\":null,\"addressLine3\":null,\"postalCode\":null,\"firstName\":null,\"lastName\":null,\"correspondenceName\":null,\"phoneNumber\":null},\"metadata\":{\"AdditionalProp1\":null,\"AdditionalProp2\":null,\"AdditionalProp3\":null,\"id\":null,\"updatedBy\":null,\"lastUpdated\":\"2025-01-18T00:06:14.0658517Z\",\"createdBy\":null,\"createdDate\":\"2025-01-18T00:06:14.0658518Z\"}}],\"checkoutStatus\":\"PendingClientAction\"}";
                PXSettings.PaymentOrchestratorService.ArrangeResponse(expectedPOResponse);
            }

            var requestContext = new
            {
                RequestID = "pr_8a3938f4-0a37-434c-bc09-ac79289834d9"
            };

            Dictionary<string, string> headers = new Dictionary<string, string>
            {
                { "x-ms-flight", flights },
                { "x-ms-request-context", JsonConvert.SerializeObject(requestContext) }
            };

            // Act
             List<PIDLResource> pidls = await GetPidlFromPXService(requestUrl, pidlCount == 0 ? HttpStatusCode.BadRequest : HttpStatusCode.OK, additionaHeaders: headers);

            Assert.IsNotNull(pidls, "Pidl is expected to be not null");
            Assert.AreEqual(pidlCount, pidls.Count, "PIDL count not expected");

            if (pidls.Count > 0)
            {
                pidls.ForEach(pidl =>
                {
                    // check accountHolderName property have a display tags with key accessibilityName and value "Cardholder name"
                    var cardholderName = pidl.GetDisplayHintById("cardholderName");
                    Assert.AreEqual("Cardholder name", cardholderName.DisplayTags["accessibilityName"]);
                });
            }
        }
    }
}